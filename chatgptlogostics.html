<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logosic Logistics • Admin Suite</title>

  <!-- PrimeFlex & PrimeIcons -->
  <link rel="stylesheet" href="https://unpkg.com/primeflex@3.3.1/primeflex.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/primeicons/primeicons.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --brand-50: #f5f3ff;
      --brand-100: #ede9fe;
      --brand-500: #8b5cf6;
      --brand-600: #7c3aed;
      --brand-700: #6d28d9;
      --brand-800: #5b21b6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --success-500: #10b981;
      --warning-500: #f59e0b;
      --error-500: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; }
    
    body { 
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      margin: 0; 
      background: var(--gray-50);
      color: var(--gray-800);
      line-height: 1.6;
    }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
      padding: .75rem 1.25rem; border-radius: 8px; border: 1px solid transparent;
      font-weight: 500; font-size: .875rem; cursor: pointer; transition: all .2s ease;
      text-decoration: none; white-space: nowrap;
    }
    
    .btn-primary { 
      background: var(--brand-600); color: #fff; 
      box-shadow: var(--shadow-sm);
    }
    .btn-primary:hover { 
      background: var(--brand-700); 
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .btn-secondary { 
      background: #fff; color: var(--gray-700); 
      border: 1px solid var(--gray-300);
      box-shadow: var(--shadow-sm);
    }
    .btn-secondary:hover { 
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .btn-sm {
      padding: .5rem .875rem;
      font-size: .8rem;
    }

    .card {
      background: #fff; 
      border: 1px solid var(--gray-200); 
      border-radius: 12px;
      padding: 1.5rem; 
      box-shadow: var(--shadow-sm);
      transition: all .2s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .dashboard-card {
      text-align: center;
      padding: 2rem 1.5rem;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .dashboard-card .icon {
      width: 3rem;
      height: 3rem;
      background: var(--brand-100);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 1.5rem;
      color: var(--brand-600);
    }

    .hidden { display: none !important; }
    
    header {
      background: #fff; 
      border-bottom: 1px solid var(--gray-200);
      padding: 1rem 2rem; 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo { 
      font-weight: 700; 
      font-size: 1.25rem; 
      color: var(--brand-700);
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .logo i {
      font-size: 1.5rem;
    }
    
    h1, h2, h3 { 
      font-weight: 700; 
      color: var(--gray-900);
      margin: 0 0 1rem 0;
    }
    
    h1 { font-size: 2rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.25rem; }
    
    .form-group {
      margin-bottom: 1rem;
      display: block;
    }
    
    .form-group label {
      display: block;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    label { 
      display: block; 
      font-weight: 500; 
      color: var(--gray-700); 
      margin-bottom: .375rem;
      font-size: .875rem;
    }
    
    input, select, textarea { 
      width: 100%; 
      padding: .75rem; 
      border: 1px solid var(--gray-300); 
      border-radius: 8px;
      font-size: .875rem;
      transition: border-color .2s ease, box-shadow .2s ease;
      background: #fff;
      display: block;
      box-sizing: border-box;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--brand-500);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      background: #fff;
      margin: 1.25rem 0 1.5rem 0;
      box-shadow: var(--shadow-sm);
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse;
    }
    
    table th { 
      background: var(--gray-50);
      padding: .875rem 1rem; 
      text-align: left; 
      font-weight: 600;
      color: var(--gray-700);
      font-size: .875rem;
      border-bottom: 1px solid var(--gray-200);
    }
    
    table td { 
      padding: 1rem; 
      border-bottom: 1px solid var(--gray-100);
      font-size: .875rem;
    }

    table tr:last-child td {
      border-bottom: none;
    }

    table tr:hover {
      background: var(--gray-50);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: .25rem .75rem;
      border-radius: 9999px;
      font-size: .75rem;
      font-weight: 500;
    }

    .status-pending { background: var(--warning-500); color: #fff; }
    .status-completed { background: var(--success-500); color: #fff; }
    .status-shipped { background: var(--brand-500); color: #fff; }
    .status-cancelled { background: var(--error-500); color: #fff; }
    .status-paid { background: var(--success-500); color: #fff; }
    .status-unpaid { background: var(--error-500); color: #fff; }
    .status-active { background: var(--success-500); color: #fff; }
    .status-inactive { background: var(--gray-400); color: #fff; }
    .status-filed { background: var(--brand-500); color: #fff; }
    .status-draft { background: var(--warning-500); color: #fff; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--brand-600);
      margin-bottom: .25rem;
    }

    .stat-label {
      color: var(--gray-600);
      font-size: .875rem;
      font-weight: 500;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
    }

    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: .25rem;
      min-width: 150px;
    }

    .actions {
      display: flex;
      gap: .5rem;
    }

    /* Staff table alignment */
    #staff table th, #staff table td { vertical-align: middle; }
    #staff table td:nth-child(1),
    #staff table td:nth-child(5),
    #staff table td:nth-child(6),
    #staff table td:nth-child(7) { white-space: nowrap; }
    #staff table td:nth-child(7) { text-align: center; }
    .btn-group { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }

    /* Dropdown Menu Styles */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-toggle {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.2s ease;
    }

    .dropdown-toggle:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      min-width: 160px;
      z-index: 1000;
      display: none;
      padding: 0.25rem 0;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      color: var(--gray-700);
      text-decoration: none;
      font-size: 0.875rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .dropdown-item:hover {
      background: var(--gray-50);
    }

    .dropdown-item i {
      width: 16px;
      text-align: center;
    }

    .dropdown-divider {
      height: 1px;
      background: var(--gray-200);
      margin: 0.25rem 0;
    }

    footer { 
      border-top: 1px solid var(--gray-200); 
      text-align: center; 
      padding: 2rem; 
      font-size: .875rem; 
      color: var(--gray-500);
      background: #fff;
      margin-top: 3rem;
    }

    /* Layout with left sidebar */
    .app-container {
      display: flex;
      gap: 0.1rem;
      padding: 0.1rem;
    }
    .sidebar {
      width: 240px;
      background: #fff;
      border-right: 1px solid var(--gray-200);
      border-radius: 2px;
      box-shadow: var(--shadow-sm);
      height: calc(100vh - 100px);
      position: sticky;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }
    .sidebar .nav-title {
      font-weight: 600;
      color: var(--gray-600);
      font-size: .8rem;
      margin-bottom: .75rem;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .sidebar .nav-button {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .75rem .875rem;
      border-radius: 8px;
      border: 1px solid transparent;
      color: var(--gray-700);
      background: #fff;
      cursor: pointer;
      font-size: .9rem;
    }
    .sidebar .nav-button:hover { 
      background: var(--gray-50);
      border-color: var(--gray-200);
    }
    .sidebar .nav-button.active {
      background: var(--brand-100);
      border-color: var(--brand-500);
      color: var(--brand-700);
      font-weight: 600;
    }
    .app-main { flex: 1; padding: .25rem 0; }
    .app-main-inner { max-width: 1280px; margin: 0 auto; width: 100%; padding: 0 .25rem; }
    .app-main > section { 
      background: #fff; 
      border: 1px solid var(--gray-200); 
      border-radius: 12px; 
      box-shadow: var(--shadow-sm);
      margin: 0 0 1.25rem 0;
      padding: 1.5rem;
    }

    /* Modal */
    .modal-overlay {
      position: fixed; 
      inset: 0; 
      background: rgba(17, 24, 39, 0.5);
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 9999;
      padding: 1rem;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #fff; 
      border-radius: 12px; 
      width: 100%; 
      max-width: 520px; 
      max-height: 90vh;
      box-shadow: var(--shadow-xl); 
      overflow: hidden; 
      border: 1px solid var(--gray-200);
      display: flex; 
      flex-direction: column;
      position: relative;
      z-index: 10000;
    }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-weight: 700; font-size: 1.1rem; color: var(--gray-900); }
    .modal-body { 
      padding: 1rem 1.25rem; 
      color: var(--gray-700); 
      flex: 1; 
      overflow-y: auto; 
      min-height: 0;
    }
    .modal-footer { 
      padding: .75rem 1.25rem; 
      border-top: 1px solid var(--gray-200); 
      display: flex; 
      gap: .5rem; 
      justify-content: flex-end; 
      flex-shrink: 0;
    }

    /* Modal content overflow handling */
    .modal-content-scrollable {
      max-height: 60vh;
      overflow-y: auto;
      padding: 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: var(--gray-50);
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .modal-form .form-group {
      margin-bottom: 1rem;
    }
    
    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .modal-form input,
    .modal-form select,
    .modal-form textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.875rem;
      background: #fff;
      box-sizing: border-box;
    }
    
    .modal-form input:focus,
    .modal-form select:focus,
    .modal-form textarea:focus {
      outline: none;
      border-color: var(--brand-500);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    /* Large modal for detailed views */
    .modal-large {
      max-width: 800px;
      max-height: 95vh;
    }

    .modal-xl {
      max-width: 1200px;
      max-height: 95vh;
    }

    /* Toast */
    .toast-container {
      position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: .5rem; z-index: 250;
    }
    .toast { background: #fff; border: 1px solid var(--gray-200); padding: .75rem 1rem; border-radius: 8px; box-shadow: var(--shadow-md); color: var(--gray-800); min-width: 240px; }
    .toast.success { border-color: var(--success-500); }
    .toast.error { border-color: var(--error-500); }

    @media (max-width: 768px) {
      .content-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .actions {
        justify-content: center;
      }
      
      header {
        padding: 1rem;
      }
      .app-container { flex-direction: column; }
      .sidebar { 
        position: relative; 
        top: 0; 
        width: 100%;
        height: auto;
      }
    }

    .login-container {
      min-height: 100vh;
      background: linear-gradient(135deg, var(--brand-600) 0%, var(--brand-800) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .login-card {
      background: #fff;
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: var(--shadow-xl);
      width: 100%;
      max-width: 400px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-header i {
      font-size: 3rem;
      color: var(--brand-600);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <section id="loginPage" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <i class="pi pi-truck"></i>
        <h2>Admin Login</h2>
        <p style="color: var(--gray-600); margin: 0;">Access your logistics dashboard</p>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" required placeholder="Enter your username" value="admin" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" required placeholder="Enter your password" value="password" />
        </div>
        <button type="submit" class="btn btn-primary w-full mt-3">
          <i class="pi pi-sign-in"></i> 
          Sign In
        </button>
        <p style="text-align: center; margin-top: 1rem; font-size: .8rem; color: var(--gray-500);">
          Demo credentials: admin / password
        </p>
      </form>
    </div>
  </section>

  <!-- MAIN DASHBOARD -->
  <div id="dashboardPage" class="hidden">
    <header>
      <div class="logo">
        <i class="pi pi-truck"></i>
        Logosic Logistics
      </div>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <span style="color: var(--gray-600); font-size: .875rem;">Welcome, Admin</span>
        <button class="btn btn-secondary btn-sm" onclick="logout()">
          <i class="pi pi-sign-out"></i> 
          Logout
        </button>
      </div>
    </header>
    
    <div class="app-container">
      <aside class="sidebar">
        <button class="nav-button active" data-target="dashboardGrid" onclick="goTo('dashboardGrid', this)"><i class="pi pi-home"></i> Dashboard</button>
        <button class="nav-button" data-target="orders" onclick="goTo('orders', this)"><i class="pi pi-shopping-cart"></i> Orders</button>
        <button class="nav-button" data-target="stock" onclick="goTo('stock', this)"><i class="pi pi-box"></i> Stock</button>
        <button class="nav-button" data-target="inventory" onclick="goTo('inventory', this)"><i class="pi pi-list"></i> Inventory</button>
        <button class="nav-button" data-target="staff" onclick="goTo('staff', this)"><i class="pi pi-users"></i> Staff</button>
        <button class="nav-button" data-target="billing" onclick="goTo('billing', this)"><i class="pi pi-credit-card"></i> Billing</button>
        <button class="nav-button" data-target="financial" onclick="goTo('financial', this)"><i class="pi pi-calculator"></i> Financial</button>
        <button class="nav-button" data-target="gst" onclick="goTo('gst', this)"><i class="pi pi-percentage"></i> GST</button>
      </aside>
      
      <main class="app-main">
        <div class="app-main-inner">
    
    <!-- Dashboard Grid -->
    <section id="dashboardGrid" class="p-4">
      <div class="content-header">
        <div>
          <h1>Admin Dashboard</h1>
          <p style="color: var(--gray-600); margin: 0;">Manage your logistics operations</p>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalOrdersCount">247</div>
          <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">1,432</div>
          <div class="stat-label">Items in Stock</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">28</div>
          <div class="stat-label">Active Staff</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">₹2.4M</div>
          <div class="stat-label">Monthly Revenue</div>
        </div>
      </div>

      <div class="grid">
        <div class="col-12 md:col-6 lg:col-4">
          <div class="card dashboard-card">
            <div>
              <div class="icon"><i class="pi pi-shopping-cart"></i></div>
              <h3>Order Management</h3>
              <p style="color: var(--gray-600); font-size: .875rem;">Track and manage customer orders</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('orders')">
              <i class="pi pi-arrow-right"></i> Open
            </button>
          </div>
        </div>
        
        <div class="col-12 md:col-6 lg:col-4">
          <div class="card dashboard-card">
            <div>
              <div class="icon"><i class="pi pi-box"></i></div>
              <h3>Stock Management</h3>
              <p style="color: var(--gray-600); font-size: .875rem;">Monitor stock levels and inventory</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('stock')">
              <i class="pi pi-arrow-right"></i> Open
            </button>
          </div>
        </div>
        
        <div class="col-12 md:col-6 lg:col-4">
          <div class="card dashboard-card">
            <div>
              <div class="icon"><i class="pi pi-list"></i></div>
              <h3>Inventory</h3>
              <p style="color: var(--gray-600); font-size: .875rem;">Complete inventory overview</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('inventory')">
              <i class="pi pi-arrow-right"></i> Open
            </button>
          </div>
        </div>
        
        <div class="col-12 md:col-6 lg:col-4">
          <div class="card dashboard-card">
            <div>
              <div class="icon"><i class="pi pi-cog"></i></div>
              <h3>Test Modal</h3>
              <p style="color: var(--gray-600); font-size: .875rem;">Test modal functionality</p>
            </div>
            <button class="btn btn-primary" onclick="testModalFix()" style="background: #28a745;">
              <i class="pi pi-check"></i> Test
            </button>
          </div>
        </div>
        
        <div class="col-12 md:col-6 lg:col-4">
          <div class="card dashboard-card">
            <div>
              <div class="icon"><i class="pi pi-users"></i></div>
              <h3>Staff Management</h3>
              <p style="color: var(--gray-600); font-size: .875rem;">Manage team members and roles</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('staff')">
              <i class="pi pi-arrow-right"></i> Open
            </button>
          </div>
        </div>
        
        <div class="col-12 md:col-6 lg:col-4">
          <div class="card dashboard-card">
            <div>
              <div class="icon"><i class="pi pi-credit-card"></i></div>
              <h3>Billing & Payments</h3>
              <p style="color: var(--gray-600); font-size: .875rem;">Handle invoices and payments</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('billing')">
              <i class="pi pi-arrow-right"></i> Open
            </button>
          </div>
        </div>
        
        <div class="col-12 md:col-6 lg:col-4">
          <div class="card dashboard-card">
            <div>
              <div class="icon"><i class="pi pi-calculator"></i></div>
              <h3>Financial Management</h3>
              <p style="color: var(--gray-600); font-size: .875rem;">Machine EMI, Electric Bills, Transport & Commission</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('financial')">
              <i class="pi pi-arrow-right"></i> Open
            </button>
          </div>
        </div>
        
        <div class="col-12 md:col-6 lg:col-4">
          <div class="card dashboard-card">
            <div>
              <div class="icon"><i class="pi pi-percentage"></i></div>
              <h3>GST Management</h3>
              <p style="color: var(--gray-600); font-size: .875rem;">GST compliance and returns</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('gst')">
              <i class="pi pi-arrow-right"></i> Open
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Order Management Screen -->
    <section id="orders" class="hidden p-4">
      <div class="content-header">
        <div>
          <h2><i class="pi pi-shopping-cart"></i> Order Management</h2>
          <p style="color: var(--gray-600); margin: 0;">Track and manage all customer orders</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="receiveOrder()">
            <i class="pi pi-plus"></i> New Order
          </button>
          <button class="btn btn-secondary" onclick="testModalFix()">
            <i class="pi pi-cog"></i> Test Modal
          </button>
          <button class="btn btn-secondary" onclick="backToDashboard()">
            <i class="pi pi-arrow-left"></i> Back
          </button>
        </div>
      </div>

      <div class="stats-grid" style="margin-bottom: 1.5rem;">
        <div class="stat-card">
          <div class="stat-value" id="pendingOrdersCount">0</div>
          <div class="stat-label">Pending Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completedOrdersCount">0</div>
          <div class="stat-label">Completed Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalOrdersValue">₹0</div>
          <div class="stat-label">Total Value</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgOrderValue">₹0</div>
          <div class="stat-label">Avg Order Value</div>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label>Order Status</label>
          <select id="statusFilter" onchange="applyFilters()">
            <option value="">All Orders</option>
            <option value="Pending">Pending</option>
            <option value="Completed">Completed</option>
            <option value="Shipped">Shipped</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date Range (From)</label>
          <input type="date" id="orderDateStart" onchange="applyFilters()" />
        </div>
        <div class="filter-group">
          <label>Date Range (To)</label>
          <input type="date" id="orderDateEnd" onchange="applyFilters()" />
        </div>
        <div class="filter-group">
          <label>Search Orders</label>
          <input type="text" id="searchOrders" placeholder="Order ID, Customer, or Material..." oninput="applyFilters()" />
        </div>
        <div class="filter-group">
          <label>Sort By</label>
          <select id="sortOrders" onchange="applyFilters()">
            <option value="date-desc">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="amount-desc">Amount (Highest First)</option>
            <option value="amount-asc">Amount (Lowest First)</option>
            <option value="customer">Customer Name</option>
            <option value="status">Status</option>
          </select>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTbody">
          </tbody>
        </table>
      </div>
    </section>

    <!-- Stock Management Screen -->
    <section id="stock" class="hidden p-4">
      <div class="content-header">
        <div>
          <h2><i class="pi pi-box"></i> Stock Management</h2>
          <p style="color: var(--gray-600); margin: 0;">Monitor and manage inventory levels</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="addStockItem()">
            <i class="pi pi-plus"></i> Add Stock
          </button>
          <button class="btn btn-secondary" onclick="backToDashboard()">
            <i class="pi pi-arrow-left"></i> Back
          </button>
        </div>
      </div>

      <div class="stats-grid" style="margin-bottom: 1.5rem;">
        <div class="stat-card">
          <div class="stat-value" id="totalItemsCount">0</div>
          <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="lowStockCount">0</div>
          <div class="stat-label">Low Stock Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="outOfStockCount">0</div>
          <div class="stat-label">Out of Stock</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalStockValue">₹0</div>
          <div class="stat-label">Total Stock Value</div>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label>Category</label>
          <select id="stockCategoryFilter" onchange="applyStockFilters()">
            <option value="">All Categories</option>
            ${STOCK_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
          </select>
        </div>
        <div class="filter-group">
          <label>Stock Level</label>
          <select id="stockLevelFilter" onchange="applyStockFilters()">
            <option value="">All Items</option>
            <option value="In Stock">In Stock</option>
            <option value="Low Stock">Low Stock</option>
            <option value="Out of Stock">Out of Stock</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Search Items</label>
          <input type="text" id="searchStockItems" placeholder="Item name, code, or supplier..." oninput="applyStockFilters()" />
        </div>
        <div class="filter-group">
          <label>Sort By</label>
          <select id="sortStockItems" onchange="applyStockFilters()">
            <option value="name">Name (A-Z)</option>
            <option value="name-desc">Name (Z-A)</option>
            <option value="stock-desc">Stock (High to Low)</option>
            <option value="stock-asc">Stock (Low to High)</option>
            <option value="price-desc">Price (High to Low)</option>
            <option value="price-asc">Price (Low to High)</option>
            <option value="category">Category</option>
            <option value="status">Status</option>
          </select>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Item Code</th>
              <th>Product Name</th>
              <th>Category</th>
              <th>Current Stock</th>
              <th>Min. Required</th>
              <th>Unit Price</th>
              <th>Total Value</th>
              <th>Status</th>
              <th>Supplier</th>
              <th>Last Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stockTbody">
          </tbody>
        </table>
      </div>
    </section>

    <!-- Inventory Screen -->
    <section id="inventory" class="hidden p-4">
      <div class="content-header">
        <div>
          <h2><i class="pi pi-list"></i> Inventory Overview</h2>
          <p style="color: var(--gray-600); margin: 0;">Complete inventory management and tracking</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary">
            <i class="pi pi-download"></i> Export Report
          </button>
          <button class="btn btn-secondary" onclick="backToDashboard()">
            <i class="pi pi-arrow-left"></i> Back
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">1,432</div>
          <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">₹45.2L</div>
          <div class="stat-label">Inventory Value</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">28</div>
          <div class="stat-label">Low Stock Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">5</div>
          <div class="stat-label">Out of Stock</div>
        </div>
      </div>

      <div class="grid">
        <div class="col-12 md:col-6">
          <div class="card">
            <h3>Category Breakdown</h3>
            <div style="margin: 1rem 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                <span>Electronics</span>
                <span>425 items</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                <span>Furniture</span>
                <span>287 items</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                <span>Medical</span>
                <span>356 items</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .5rem;">
                <span>Industrial</span>
                <span>198 items</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Others</span>
                <span>166 items</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-12 md:col-6">
          <div class="card">
            <h3>Recent Movements</h3>
            <div style="margin: 1rem 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem; padding-bottom: .5rem; border-bottom: 1px solid var(--gray-100);">
                <div>
                  <strong>Samsung Galaxy Smartphone</strong>
                  <div style="font-size: .8rem; color: var(--gray-500);">Stock Added: +25 units</div>
                </div>
                <span style="color: var(--success-500); font-weight: 500;">+25</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem; padding-bottom: .5rem; border-bottom: 1px solid var(--gray-100);">
                <div>
                  <strong>Office Chair Premium</strong>
                  <div style="font-size: .8rem; color: var(--gray-500);">Order Fulfilled: -7 units</div>
                </div>
                <span style="color: var(--error-500); font-weight: 500;">-7</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem; padding-bottom: .5rem; border-bottom: 1px solid var(--gray-100);">
                <div>
                  <strong>Digital Thermometer</strong>
                  <div style="font-size: .8rem; color: var(--gray-500);">Stock Added: +50 units</div>
                </div>
                <span style="color: var(--success-500); font-weight: 500;">+50</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>Laptop Dell Inspiron</strong>
                  <div style="font-size: .8rem; color: var(--gray-500);">Order Fulfilled: -12 units</div>
                </div>
                <span style="color: var(--error-500); font-weight: 500;">-12</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Staff Management Screen -->
    <section id="staff" class="hidden p-4">
      <div class="content-header">
        <div>
          <h2><i class="pi pi-users"></i> Staff Management</h2>
          <p style="color: var(--gray-600); margin: 0;">Manage employee attendance, payroll, and leave requests</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="addStaff()">
            <i class="pi pi-plus"></i> Add Staff
          </button>
          <button class="btn btn-secondary" onclick="viewLeaveRequests()">
            <i class="pi pi-calendar"></i> Leave Requests
          </button>
          <button class="btn btn-secondary" onclick="viewAttendanceReport()">
            <i class="pi pi-chart-bar"></i> Attendance Report
          </button>
          <button class="btn btn-secondary" onclick="backToDashboard()">
            <i class="pi pi-arrow-left"></i> Back
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalStaffCount">0</div>
          <div class="stat-label">Total Staff</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="presentTodayCount">0</div>
          <div class="stat-label">Present Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="onLeaveCount">0</div>
          <div class="stat-label">On Leave</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pendingLeaveCount">0</div>
          <div class="stat-label">Pending Leave</div>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label>Department</label>
          <select id="deptFilter" onchange="renderStaff()">
            <option value="">All Departments</option>
            <option value="Production">Production</option>
            <option value="Quality">Quality</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Admin">Admin</option>
            <option value="HR">HR</option>
            <option value="Finance">Finance</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Status</label>
          <select id="statusFilter" onchange="renderStaff()">
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="On Leave">On Leave</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Shift</label>
          <select id="shiftFilter" onchange="renderStaff()">
            <option value="">All Shifts</option>
            <option value="Morning">Morning (9 AM - 6 PM)</option>
            <option value="Evening">Evening (2 PM - 11 PM)</option>
            <option value="Night">Night (10 PM - 7 AM)</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Search</label>
          <input type="text" id="searchStaff" placeholder="Search staff..." oninput="renderStaff()" />
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Role</th>
              <th>Department</th>
              <th>Shift</th>
              <th>Contact</th>
              <th>Join Date</th>
              <th>Status</th>
              <th>Today's Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="staffTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Billing Screen -->
    <section id="billing" class="hidden p-4">
      <div class="content-header">
        <div>
          <h2><i class="pi pi-credit-card"></i> Billing & Payments</h2>
          <p style="color: var(--gray-600); margin: 0;">Manage invoices, payments, and financial records</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="openCreateInvoiceModal()">
            <i class="pi pi-plus"></i> Create Invoice
          </button>
          <button class="btn btn-secondary" onclick="backToDashboard()">
            <i class="pi pi-arrow-left"></i> Back
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">₹2.4M</div>
          <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">₹45,780</div>
          <div class="stat-label">Pending Payments</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">156</div>
          <div class="stat-label">Invoices Generated</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">12</div>
          <div class="stat-label">Overdue Payments</div>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label>Payment Status</label>
          <select>
            <option>All Invoices</option>
            <option>Paid</option>
            <option>Unpaid</option>
            <option>Overdue</option>
            <option>Partial</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date Range</label>
          <input type="date" />
        </div>
        <div class="filter-group">
          <label>Search Invoices</label>
          <input type="text" placeholder="Invoice # or customer..." />
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Invoice #</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Issue Date</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="billingTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- GST Management Screen -->
    <section id="gst" class="hidden p-4">
      <div class="content-header">
        <div>
          <h2><i class="pi pi-percentage"></i> GST Management</h2>
          <p style="color: var(--gray-600); margin: 0;">Handle GST compliance, returns, and tax calculations</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="openGstReturnModal()">
            <i class="pi pi-plus"></i> File Return
          </button>
          <button class="btn btn-secondary" onclick="backToDashboard()">
            <i class="pi pi-arrow-left"></i> Back
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">₹4.32L</div>
          <div class="stat-label">Total GST Collected</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">₹1.85L</div>
          <div class="stat-label">GST Paid</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">₹2.47L</div>
          <div class="stat-label">GST Payable</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">8</div>
          <div class="stat-label">Returns Filed</div>
        </div>
      </div>

      <div class="grid">
        <div class="col-12 md:col-6">
          <div class="card">
            <h3>Monthly GST Summary</h3>
            <div style="margin: 1rem 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem; padding: .75rem; background: var(--gray-50); border-radius: 8px;">
                <div>
                  <strong>August 2025</strong>
                  <div style="font-size: .8rem; color: var(--gray-500);">GSTR-1 & GSTR-3B</div>
                </div>
                <span class="status-badge status-filed">Filed</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem; padding: .75rem; background: var(--gray-50); border-radius: 8px;">
                <div>
                  <strong>July 2025</strong>
                  <div style="font-size: .8rem; color: var(--gray-500);">GSTR-1 & GSTR-3B</div>
                </div>
                <span class="status-badge status-filed">Filed</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: .75rem; background: var(--warning-500); background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                <div>
                  <strong>September 2025</strong>
                  <div style="font-size: .8rem; color: var(--gray-500);">GSTR-1 Due: Sept 11</div>
                </div>
                <span class="status-badge status-draft">Draft</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-12 md:col-6">
          <div class="card">
            <h3>GST Rate Breakdown</h3>
            <div style="margin: 1rem 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
                <span>CGST (9%)</span>
                <span style="font-weight: 600;">₹1,94,400</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
                <span>SGST (9%)</span>
                <span style="font-weight: 600;">₹1,94,400</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: .75rem;">
                <span>IGST (18%)</span>
                <span style="font-weight: 600;">₹43,200</span>
              </div>
              <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--gray-200);">
              <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.1rem;">
                <span>Total GST</span>
                <span style="color: var(--brand-600);">₹4,32,000</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>GSTIN</th>
              <th>Return</th>
              <th>Period</th>
              <th>Taxable Value</th>
              <th>IGST</th>
              <th>CGST</th>
              <th>SGST</th>
              <th>Total</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="gstTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Financial Management Screen -->
    <section id="financial" class="hidden p-4">
      <div class="content-header">
        <div>
          <h2><i class="pi pi-calculator"></i> Financial Management</h2>
          <p style="color: var(--gray-600); margin: 0;">Manage Machine EMI, Electric Bills, Transport Costs, and Commission</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="addFinancialRecord()">
            <i class="pi pi-plus"></i> Add Record
          </button>
          <button class="btn btn-secondary" onclick="backToDashboard()">
            <i class="pi pi-arrow-left"></i> Back
          </button>
        </div>
      </div>

      <div class="stats-grid" style="margin-bottom: 1.5rem;">
        <div class="stat-card">
          <div class="stat-value" id="totalMachineEMI">₹0</div>
          <div class="stat-label">Total Machine EMI</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalElectricBill">₹0</div>
          <div class="stat-label">Total Electric Bill</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalTransportCost">₹0</div>
          <div class="stat-label">Total Transport Cost</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalCommission">₹0</div>
          <div class="stat-label">Total Commission</div>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label>Record Type</label>
          <select id="financialTypeFilter" onchange="applyFinancialFilters()">
            <option value="">All Types</option>
            <option value="Machine EMI">Machine EMI</option>
            <option value="Electric Bill">Electric Bill</option>
            <option value="Transport Cost">Transport Cost</option>
            <option value="Commission">Commission</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date Range (From)</label>
          <input type="date" id="financialDateStart" onchange="applyFinancialFilters()" />
        </div>
        <div class="filter-group">
          <label>Date Range (To)</label>
          <input type="date" id="financialDateEnd" onchange="applyFinancialFilters()" />
        </div>
        <div class="filter-group">
          <label>Search Records</label>
          <input type="text" id="searchFinancialRecords" placeholder="Description or amount..." oninput="applyFinancialFilters()" />
        </div>
        <div class="filter-group">
          <label>Sort By</label>
          <select id="sortFinancialRecords" onchange="applyFinancialFilters()">
            <option value="date-desc">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="amount-desc">Amount (Highest First)</option>
            <option value="amount-asc">Amount (Lowest First)</option>
            <option value="type">Type</option>
          </select>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Payment Method</th>
              <th>Reference</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="financialTbody">
          </tbody>
        </table>
      </div>
    </section>
        </div>
      </main>
    </div>

    <footer>
      <p>© <span id="currentYear"></span> Logosic Logistics • Admin Application</p>
      <p style="margin: .5rem 0 0 0; font-size: .8rem;">Built with modern web technologies for optimal performance</p>
    </footer>
  </div>

  <!-- Modal & Toast Roots -->
  <div id="modalOverlay" class="modal-overlay" onclick="if(event.target===this) closeModal()">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Details</h3>
        <button class="btn btn-secondary btn-sm" onclick="closeModal()" style="background: #dc3545; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">
          <i class="pi pi-times"></i>
        </button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>
  <div id="toastContainer" class="toast-container"></div>

  <script>
    document.getElementById("currentYear").textContent = new Date().getFullYear();

    // Login functionality
    document.getElementById("loginForm").addEventListener("submit", e => {
      e.preventDefault();
      
      // Add loading animation (optional)
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="pi pi-spinner pi-spin"></i> Signing In...';
      submitBtn.disabled = true;
      
      // Simulate login delay
      setTimeout(() => {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("dashboardPage").classList.remove("hidden");
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }, 1000);
    });

    // Logout functionality
    function logout() {
      confirmModal('Logout', 'Are you sure you want to logout?', () => {
        document.getElementById("dashboardPage").classList.add("hidden");
        document.getElementById("loginPage").classList.remove("hidden");
        
        // Reset form
        document.getElementById("loginForm").reset();
        document.querySelector('input[type="text"]').value = "admin";
        document.querySelector('input[type="password"]').value = "password";
      });
    }

    // Navigation functions
    function showScreen(screenId) {
      // Hide dashboard grid
      document.getElementById("dashboardGrid").classList.add("hidden");
      
      // Hide all other screens
      const screens = ['orders', 'stock', 'inventory', 'staff', 'billing', 'financial', 'gst'];
      screens.forEach(screen => {
        if (screen !== screenId) {
          document.getElementById(screen).classList.add("hidden");
        }
      });
      
      // Show selected screen
      document.getElementById(screenId).classList.remove("hidden");
      
      // Trigger screen-specific renders
      if (screenId === 'orders') renderOrders();
      if (screenId === 'stock') renderStock();
      if (screenId === 'billing') renderInvoices();
      if (screenId === 'financial') renderFinancialRecords();
      if (screenId === 'staff') renderStaff();
      if (screenId === 'gst') renderGstReturns();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goTo(targetId, btn) {
      const allNav = document.querySelectorAll('.sidebar .nav-button');
      allNav.forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      if (targetId === 'dashboardGrid') {
        backToDashboard();
      } else {
        showScreen(targetId);
      }
    }

    function backToDashboard() {
      // Hide all screens
      const screens = ['orders', 'stock', 'inventory', 'staff', 'billing', 'financial', 'gst'];
      screens.forEach(screen => {
        document.getElementById(screen).classList.add("hidden");
      });
      
      // Show dashboard grid
      document.getElementById("dashboardGrid").classList.remove("hidden");
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Add some interactive features
    document.addEventListener('DOMContentLoaded', function() {
      // Add hover effects to cards
      const cards = document.querySelectorAll('.dashboard-card');
      cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-4px)';
        });
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(-2px)';
        });
      });

      // Add click handlers to table rows
      const tableRows = document.querySelectorAll('table tbody tr');
      tableRows.forEach(row => {
        row.addEventListener('click', function() {
          // Remove previous selection
          tableRows.forEach(r => r.style.backgroundColor = '');
          // Highlight selected row
          this.style.backgroundColor = 'var(--brand-50)';
        });
      });

      // Add form validation and interactive features
      const inputs = document.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          this.parentElement.style.transform = 'scale(1.02)';
        });
        input.addEventListener('blur', function() {
          this.parentElement.style.transform = 'scale(1)';
        });
      });
    });

    // --------------------
    // Staff: Store + Rendering + Actions
    // --------------------
    const STAFF_STORAGE_KEY = 'logosic_staff_v1';
    const ATTENDANCE_STORAGE_KEY = 'logosic_attendance_v1';
    function loadStaff() {
      try { const raw = localStorage.getItem(STAFF_STORAGE_KEY); if (raw) return JSON.parse(raw); } catch (_) {}
      const seeded = [
        { id:'EMP-001', name:'Rahul Verma', role:'Delivery Driver', dept:'Logistics', contact:'+91 98765 43210', join:'2023-01-15', status:'Active' },
        { id:'EMP-002', name:'Meera Joshi', role:'Warehouse Manager', dept:'Warehouse', contact:'+91 87654 32109', join:'2022-08-10', status:'Active' },
        { id:'EMP-003', name:'Suresh Kumar', role:'Inventory Clerk', dept:'Warehouse', contact:'+91 76543 21098', join:'2023-03-22', status:'Active' },
        { id:'EMP-004', name:'Anita Sharma', role:'Customer Service Rep', dept:'Customer Service', contact:'+91 65432 10987', join:'2023-07-01', status:'Active' },
        { id:'EMP-005', name:'Deepak Singh', role:'Operations Supervisor', dept:'Administration', contact:'+91 54321 09876', join:'2022-12-05', status:'On Leave' }
      ];
      saveStaff(seeded); return seeded;
    }
    function saveStaff(list) { localStorage.setItem(STAFF_STORAGE_KEY, JSON.stringify(list)); }
    function loadAttendance() { try { const r = localStorage.getItem(ATTENDANCE_STORAGE_KEY); if (r) return JSON.parse(r); } catch(_){} return {}; }
    function saveAttendance(map) { localStorage.setItem(ATTENDANCE_STORAGE_KEY, JSON.stringify(map)); }
    function staffBadgeClass(status){ const s=(status||'').toLowerCase(); if(s==='active') return 'status-badge status-active'; if(s==='on leave') return 'status-badge status-inactive'; return 'status-badge status-pending'; }
    function renderStaff(){
      const tbody=document.getElementById('staffTbody'); if(!tbody) return;
      const staff=loadStaff(); const attendance=loadAttendance(); const today=new Date().toISOString().slice(0,10);
      
      // Apply filters
      const deptFilter = document.getElementById('deptFilter')?.value || '';
      const statusFilter = document.getElementById('statusFilter')?.value || '';
      const shiftFilter = document.getElementById('shiftFilter')?.value || '';
      const searchTerm = document.getElementById('searchStaff')?.value?.toLowerCase() || '';
      
      let filtered = staff.filter(emp => {
        if (deptFilter && emp.dept !== deptFilter) return false;
        if (statusFilter && emp.status !== statusFilter) return false;
        if (shiftFilter && emp.shift !== shiftFilter) return false;
        if (searchTerm) {
          const searchText = `${emp.id} ${emp.name} ${emp.role} ${emp.dept} ${emp.contact}`.toLowerCase();
          if (!searchText.includes(searchTerm)) return false;
        }
        return true;
      });
      
      tbody.innerHTML = filtered.map(emp=>{
        const map=attendance[emp.id]||{}; 
        const todayAttendance = map[today];
        let todayStatus = '-';
        let todayStatusClass = 'status-badge status-pending';
        
        if (todayAttendance) {
          if (typeof todayAttendance === 'string') {
            // Old format
            todayStatus = todayAttendance === 'P' ? 'Present' : 'Absent';
            todayStatusClass = todayAttendance === 'P' ? 'status-badge status-active' : 'status-badge status-inactive';
          } else {
            // New format with detailed attendance
            todayStatus = todayAttendance.status === 'P' ? 'Present' : 'Absent';
            todayStatusClass = todayAttendance.status === 'P' ? 'status-badge status-active' : 'status-badge status-inactive';
          }
        }
        
        const dropdownId = `staffDropdown_${emp.id}`;
        const actions = `
          <div class="dropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown('${dropdownId}')">
              <i class="pi pi-ellipsis-v"></i> Actions
            </button>
            <div class="dropdown-menu" id="${dropdownId}">
              <a class="dropdown-item" onclick="biometricCheckIn('${emp.id}', event); closeAllDropdowns();">
                <i class="pi pi-sign-in"></i> Check In
              </a>
              <a class="dropdown-item" onclick="biometricCheckOut('${emp.id}', event); closeAllDropdowns();">
                <i class="pi pi-sign-out"></i> Check Out
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="markAttendance('${emp.id}','P',event); closeAllDropdowns();">
                <i class="pi pi-check"></i> Mark Present
              </a>
              <a class="dropdown-item" onclick="markAttendance('${emp.id}','A',event); closeAllDropdowns();">
                <i class="pi pi-times"></i> Mark Absent
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="generatePayslip('${emp.id}',event); closeAllDropdowns();">
                <i class="pi pi-file"></i> Generate Payslip
              </a>
              <a class="dropdown-item" onclick="editStaff('${emp.id}', event); closeAllDropdowns();">
                <i class="pi pi-pencil"></i> Edit Staff
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="deleteStaff('${emp.id}', event); closeAllDropdowns();" style="color: var(--error-500);">
                <i class="pi pi-trash"></i> Delete Staff
              </a>
            </div>
          </div>
        `;
        return `
          <tr>
            <td><strong>${emp.id}</strong></td>
            <td>${emp.name}</td>
            <td>${emp.role}</td>
            <td>${emp.dept}</td>
            <td>${emp.shift || 'Morning'}</td>
            <td>${emp.contact}</td>
            <td>${emp.join}</td>
            <td><span class="${staffBadgeClass(emp.status)}">${emp.status}</span></td>
            <td><span class="${todayStatusClass}">${todayStatus}</span></td>
            <td>${actions}</td>
          </tr>
        `;
      }).join('');
      
      // Update statistics
      updateStaffStats();
    }
    function markAttendance(empId, mark, evt){ if(evt) evt.stopPropagation(); const map=loadAttendance(); const day=new Date().toISOString().slice(0,10); map[empId]=map[empId]||{}; map[empId][day]=mark; saveAttendance(map); showToast('Attendance saved','success'); }
    function monthAttendanceSummary(empId, ym){ const map=loadAttendance()[empId]||{}; const days=Object.keys(map).filter(d=>d.startsWith(ym)); const p=days.filter(d=>map[d]==='P').length; const a=days.filter(d=>map[d]==='A').length; return {present:p, absent:a}; }
    function generatePayslip(empId, evt){
      if(evt) evt.stopPropagation();
      const staff=loadStaff(); const emp=staff.find(s=>s.id===empId); if(!emp) return;
      const now=new Date(); const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const summary=monthAttendanceSummary(empId, ym);
      const basic=8000; const hra=Math.round(basic*0.4); const allowances=1000; const gross=basic+hra+allowances; const perDay=Math.round(gross/26); const absentDeduction=summary.absent*perDay; const net=gross-absentDeduction; const qrData=encodeURIComponent(`${emp.id}|${emp.name}|${ym}|${net}`);
      const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${qrData}`;
      const html=`
        <html><head><title>Payslip ${emp.id} ${ym}</title><meta charset='utf-8'/>
        <style>body{font-family:Inter,Segoe UI,Roboto,sans-serif;background:#f8fafc;margin:0;padding:24px;color:#111827}
        .slip{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:24px;max-width:850px;margin:0 auto}
        .row{display:flex;justify-content:space-between;align-items:flex-start;gap:16px} table{border-collapse:collapse;width:100%;margin-top:12px}
        th,td{border:1px solid #e5e7eb;padding:8px} th{background:#f9fafb;text-align:left}
        .muted{color:#6b7280}
        </style></head><body>
        <div class='slip'>
          <div class='row'>
            <div>
              <div style='font-weight:700'>Logosic Logistics</div>
              <div class='muted'>Payslip for ${ym}</div>
            </div>
            <img src='${qrUrl}' width='120' height='120'/>
          </div>
          <table>
            <tr><th>Employee</th><td>${emp.name}</td><th>ID</th><td>${emp.id}</td></tr>
            <tr><th>Role</th><td>${emp.role}</td><th>Department</th><td>${emp.dept}</td></tr>
          </table>
          <table>
            <thead><tr><th>Earnings</th><th>Amount</th><th>Deductions</th><th>Amount</th></tr></thead>
            <tbody>
              <tr><td>Basic</td><td>${formatINR(basic)}</td><td>Absences (${summary.absent} days)</td><td>${formatINR(absentDeduction)}</td></tr>
              <tr><td>HRA</td><td>${formatINR(hra)}</td><td></td><td></td></tr>
              <tr><td>Allowances</td><td>${formatINR(allowances)}</td><td></td><td></td></tr>
              <tr><th>Total Earnings</th><th>${formatINR(gross)}</th><th>Net Deductions</th><th>${formatINR(absentDeduction)}</th></tr>
            </tbody>
          </table>
          <div style='text-align:right;margin-top:8px;font-weight:700'>Net Pay: ${formatINR(net)}</div>
          <div class='muted' style='margin-top:8px'>This is a system-generated payslip.</div>
        </div>
        <script>window.onload=()=>{window.print();setTimeout(()=>window.close(),300)}<\/script>
        </body></html>`;
      const w=window.open('', '_blank'); if(!w){ showToast('Popup blocked. Allow popups to print.', 'error'); return; } w.document.open(); w.document.write(html); w.document.close();
    }

    // Enhanced Staff Management Functions
    const STAFF_DEPARTMENTS = ['Production', 'Quality', 'Maintenance', 'Admin', 'HR', 'Finance'];
    const STAFF_ROLES = ['Manager', 'Supervisor', 'Operator', 'Technician', 'Assistant', 'Clerk', 'Driver'];
    const SHIFT_TYPES = [
      { name: 'Morning', start: '09:00', end: '18:00', duration: 9 },
      { name: 'Evening', start: '14:00', end: '23:00', duration: 9 },
      { name: 'Night', start: '22:00', end: '07:00', duration: 9 }
    ];
    const LEAVE_TYPES = ['Sick Leave', 'Personal Leave', 'Vacation', 'Emergency', 'Maternity/Paternity'];
    const LEAVE_STATUS = ['Pending', 'Approved', 'Rejected'];
    
    const LEAVE_STORAGE_KEY = 'logistics_leave_requests';
    const SHIFTS_STORAGE_KEY = 'logistics_shifts';
    
    function loadLeaveRequests(){ const stored=localStorage.getItem(LEAVE_STORAGE_KEY); return stored?JSON.parse(stored):[]; }
    function saveLeaveRequests(list){ localStorage.setItem(LEAVE_STORAGE_KEY, JSON.stringify(list)); }
    function loadShifts(){ const stored=localStorage.getItem(SHIFTS_STORAGE_KEY); return stored?JSON.parse(stored):{}; }
    function saveShifts(map){ localStorage.setItem(SHIFTS_STORAGE_KEY, JSON.stringify(map)); }
    
    function leaveBadgeClass(status){ const s=(status||'').toLowerCase(); if(s==='approved') return 'status-badge status-active'; if(s==='rejected') return 'status-badge status-inactive'; return 'status-badge status-pending'; }
    function attendanceBadgeClass(status){ const s=(status||'').toLowerCase(); if(s==='present') return 'status-badge status-active'; if(s==='absent') return 'status-badge status-inactive'; if(s==='late') return 'status-badge status-pending'; return 'status-badge status-pending'; }
    
    function generateStaffId(department, existing) {
      const deptCode = department.substring(0, 3).toUpperCase();
      let max = 0;
      existing.forEach(emp => {
        const n = parseInt((emp.id || '').replace(/[^0-9]/g, ''), 10);
        if (!isNaN(n)) max = Math.max(max, n);
      });
      const next = String(max + 1).padStart(3, '0');
      return `${deptCode}-${next}`;
    }
    
    function generateLeaveId() {
      return `LEAVE-${Date.now()}`;
    }

    // Enhanced Staff Management Functions
    function addStaff() {
      const body = `
        <div class="form-group">
          <label>Full Name *</label>
          <input id="staffName" type="text" placeholder="Enter full name" required />
        </div>
        <div class="form-group">
          <label>Role *</label>
          <select id="staffRole" required>
            <option value="">Select role...</option>
            ${STAFF_ROLES.map(role => `<option value="${role}">${role}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Department *</label>
          <select id="staffDepartment" required>
            <option value="">Select department...</option>
            ${STAFF_DEPARTMENTS.map(dept => `<option value="${dept}">${dept}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Shift *</label>
          <select id="staffShift" required>
            <option value="">Select shift...</option>
            ${SHIFT_TYPES.map(shift => `<option value="${shift.name}">${shift.name} (${shift.start} - ${shift.end})</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Contact Number *</label>
          <input id="staffContact" type="tel" placeholder="Enter contact number" required />
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input id="staffEmail" type="email" placeholder="Enter email address" />
        </div>
        <div class="form-group">
          <label>Address</label>
          <textarea id="staffAddress" placeholder="Enter address" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Join Date *</label>
          <input id="staffJoinDate" type="date" required />
        </div>
        <div class="form-group">
          <label>Basic Salary (INR) *</label>
          <input id="staffSalary" type="number" min="0" placeholder="Enter basic salary" required />
        </div>
        <div class="form-group">
          <label>Emergency Contact</label>
          <input id="staffEmergencyContact" type="tel" placeholder="Enter emergency contact" />
        </div>
      `;
      
      openModal('Add New Staff Member', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Add Staff', type: 'primary', action: () => {
          const name = document.getElementById('staffName').value.trim();
          const role = document.getElementById('staffRole').value;
          const department = document.getElementById('staffDepartment').value;
          const shift = document.getElementById('staffShift').value;
          const contact = document.getElementById('staffContact').value.trim();
          const email = document.getElementById('staffEmail').value.trim();
          const address = document.getElementById('staffAddress').value.trim();
          const joinDate = document.getElementById('staffJoinDate').value;
          const salary = parseInt(document.getElementById('staffSalary').value, 10);
          const emergencyContact = document.getElementById('staffEmergencyContact').value.trim();
          
          if (!name || !role || !department || !shift || !contact || !joinDate || isNaN(salary) || salary <= 0) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const staff = loadStaff();
          const id = generateStaffId(department, staff);
          
          const newStaff = {
            id,
            name,
            role,
            dept: department,
            shift: shift,
            contact,
            email: email || 'N/A',
            address: address || 'N/A',
            join: joinDate,
            salary,
            emergencyContact: emergencyContact || 'N/A',
            status: 'Active',
            createdAt: new Date().toISOString()
          };
          
          staff.unshift(newStaff);
          saveStaff(staff);
          closeModal();
          renderStaff();
          updateStaffStats();
          showToast(`Staff member ${name} added successfully`, 'success');
        }}
      ]);
      
      // Set default join date to today
      setTimeout(() => {
        const joinDateInput = document.getElementById('staffJoinDate');
        if (joinDateInput) {
          joinDateInput.value = new Date().toISOString().slice(0, 10);
        }
      }, 100);
    }

    function viewLeaveRequests() {
      const leaveRequests = loadLeaveRequests();
      const staff = loadStaff();
      
      const html = `
        <div style="margin-bottom: 1rem;">
          <h3 style="margin-bottom: 0.5rem;">Leave Requests</h3>
          <p style="color: var(--gray-600); margin: 0;">Manage employee leave requests and approvals</p>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Employee</th>
                <th>Leave Type</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Days</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${leaveRequests.map(req => {
                const emp = staff.find(s => s.id === req.employeeId);
                const days = Math.ceil((new Date(req.endDate) - new Date(req.startDate)) / (1000 * 60 * 60 * 24)) + 1;
                return `
                  <tr>
                    <td><strong>${req.id}</strong></td>
                    <td>${emp ? emp.name : 'Unknown'}</td>
                    <td>${req.type}</td>
                    <td>${req.startDate}</td>
                    <td>${req.endDate}</td>
                    <td>${days}</td>
                    <td><span class="${leaveBadgeClass(req.status)}">${req.status}</span></td>
                    <td>
                      <div class="btn-group">
                        ${req.status === 'Pending' ? `
                          <button class="btn btn-primary btn-sm" onclick="approveLeave('${req.id}')">Approve</button>
                          <button class="btn btn-secondary btn-sm" onclick="rejectLeave('${req.id}')">Reject</button>
                        ` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="viewLeaveDetails('${req.id}')">View</button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      openModal('Leave Requests', html, [
        { label: 'Close', type: 'secondary', action: closeModal }
      ], 'large');
    }

    function viewAttendanceReport() {
      const staff = loadStaff();
      const attendance = loadAttendance();
      const today = new Date().toISOString().slice(0, 10);
      const currentMonth = new Date().toISOString().slice(0, 7);
      
      // Calculate weekly and monthly stats
      const weeklyStats = {};
      const monthlyStats = {};
      
      staff.forEach(emp => {
        const empAttendance = attendance[emp.id] || {};
        const days = Object.keys(empAttendance).filter(d => d.startsWith(currentMonth));
        const present = days.filter(d => empAttendance[d] === 'P').length;
        const absent = days.filter(d => empAttendance[d] === 'A').length;
        
        monthlyStats[emp.id] = { present, absent, total: days.length };
        
        // Weekly stats (last 7 days)
        const weekDays = Object.keys(empAttendance).filter(d => {
          const date = new Date(d);
          const today = new Date();
          const diffTime = today - date;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays <= 7;
        });
        const weekPresent = weekDays.filter(d => empAttendance[d] === 'P').length;
        const weekAbsent = weekDays.filter(d => empAttendance[d] === 'A').length;
        
        weeklyStats[emp.id] = { present: weekPresent, absent: weekAbsent, total: weekDays.length };
      });
      
      const html = `
        <div style="margin-bottom: 1rem;">
          <h3 style="margin-bottom: 0.5rem;">Attendance Report</h3>
          <p style="color: var(--gray-600); margin: 0;">Weekly and monthly attendance statistics</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
          <div class="stat-card">
            <div class="stat-value">${Object.values(weeklyStats).reduce((sum, stat) => sum + stat.present, 0)}</div>
            <div class="stat-label">Present This Week</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${Object.values(monthlyStats).reduce((sum, stat) => sum + stat.present, 0)}</div>
            <div class="stat-label">Present This Month</div>
          </div>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Department</th>
                <th>Weekly Present</th>
                <th>Weekly Absent</th>
                <th>Monthly Present</th>
                <th>Monthly Absent</th>
                <th>Attendance %</th>
              </tr>
            </thead>
            <tbody>
              ${staff.map(emp => {
                const weekly = weeklyStats[emp.id] || { present: 0, absent: 0, total: 0 };
                const monthly = monthlyStats[emp.id] || { present: 0, absent: 0, total: 0 };
                const weeklyPercent = weekly.total > 0 ? Math.round((weekly.present / weekly.total) * 100) : 0;
                const monthlyPercent = monthly.total > 0 ? Math.round((monthly.present / monthly.total) * 100) : 0;
                const avgPercent = Math.round((weeklyPercent + monthlyPercent) / 2);
                
                return `
                  <tr>
                    <td><strong>${emp.name}</strong><br/><small>${emp.id}</small></td>
                    <td>${emp.dept}</td>
                    <td>${weekly.present}</td>
                    <td>${weekly.absent}</td>
                    <td>${monthly.present}</td>
                    <td>${monthly.absent}</td>
                    <td>
                      <span class="${avgPercent >= 80 ? 'status-badge status-active' : avgPercent >= 60 ? 'status-badge status-pending' : 'status-badge status-inactive'}">
                        ${avgPercent}%
                      </span>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      openModal('Attendance Report', html, [
        { label: 'Close', type: 'secondary', action: closeModal },
        { label: 'Export', type: 'primary', action: () => exportAttendanceReport() }
      ], 'xl');
    }

    function biometricCheckIn(empId) {
      const staff = loadStaff();
      const emp = staff.find(s => s.id === empId);
      if (!emp) return;
      
      const body = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <h3 style="color: var(--brand-600); margin-bottom: 0.5rem;">Biometric Check-In</h3>
          <div style="font-size: 0.9rem; color: var(--gray-600);">${emp.name} (${emp.id})</div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Employee Details</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><strong>Department:</strong> ${emp.dept}</div>
            <div><strong>Shift:</strong> ${emp.shift}</div>
            <div><strong>Role:</strong> ${emp.role}</div>
            <div><strong>Expected Time:</strong> ${getShiftStartTime(emp.shift)}</div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Check-in Time *</label>
          <input id="checkinTime" type="datetime-local" required />
        </div>
        
        <div class="form-group">
          <label>Biometric ID</label>
          <input id="biometricId" type="text" placeholder="Enter biometric ID or scan" />
        </div>
        
        <div class="form-group">
          <label>Notes</label>
          <textarea id="checkinNotes" placeholder="Any notes or remarks..." rows="2"></textarea>
        </div>
      `;
      
      openModal('Biometric Check-In', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Check In', type: 'primary', action: () => {
          const checkinTime = document.getElementById('checkinTime').value;
          const biometricId = document.getElementById('biometricId').value.trim();
          const notes = document.getElementById('checkinNotes').value.trim();
          
          if (!checkinTime) {
            showToast('Please select check-in time', 'error');
            return;
          }
          
          const attendance = loadAttendance();
          const today = new Date().toISOString().slice(0, 10);
          if (!attendance[empId]) attendance[empId] = {};
          
          attendance[empId][today] = {
            status: 'P',
            checkin: checkinTime,
            biometricId: biometricId || 'N/A',
            notes: notes || 'N/A',
            shift: emp.shift
          };
          
          saveAttendance(attendance);
          closeModal();
          renderStaff();
          updateStaffStats();
          showToast(`${emp.name} checked in successfully`, 'success');
        }}
      ]);
      
      // Set default check-in time to now
      setTimeout(() => {
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        const checkinInput = document.getElementById('checkinTime');
        if (checkinInput) {
          checkinInput.value = localDateTime;
        }
      }, 100);
    }

    function biometricCheckOut(empId) {
      const staff = loadStaff();
      const emp = staff.find(s => s.id === empId);
      if (!emp) return;
      
      const attendance = loadAttendance();
      const today = new Date().toISOString().slice(0, 10);
      const todayAttendance = attendance[empId]?.[today];
      
      if (!todayAttendance || todayAttendance.status !== 'P') {
        showToast('Employee must check in first', 'error');
        return;
      }
      
      const body = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <h3 style="color: var(--brand-600); margin-bottom: 0.5rem;">Biometric Check-Out</h3>
          <div style="font-size: 0.9rem; color: var(--gray-600);">${emp.name} (${emp.id})</div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Check-in Details</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><strong>Check-in Time:</strong> ${todayAttendance.checkin}</div>
            <div><strong>Shift:</strong> ${todayAttendance.shift}</div>
            <div><strong>Expected End:</strong> ${getShiftEndTime(emp.shift)}</div>
            <div><strong>Hours Worked:</strong> ${calculateHoursWorked(todayAttendance.checkin)}</div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Check-out Time *</label>
          <input id="checkoutTime" type="datetime-local" required />
        </div>
        
        <div class="form-group">
          <label>Biometric ID</label>
          <input id="biometricId" type="text" placeholder="Enter biometric ID or scan" />
        </div>
        
        <div class="form-group">
          <label>End of Day Notes</label>
          <textarea id="checkoutNotes" placeholder="Any notes or remarks..." rows="2"></textarea>
        </div>
      `;
      
      openModal('Biometric Check-Out', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Check Out', type: 'primary', action: () => {
          const checkoutTime = document.getElementById('checkoutTime').value;
          const biometricId = document.getElementById('biometricId').value.trim();
          const notes = document.getElementById('checkoutNotes').value.trim();
          
          if (!checkoutTime) {
            showToast('Please select check-out time', 'error');
            return;
          }
          
          const checkinTime = new Date(todayAttendance.checkin);
          const checkoutTimeObj = new Date(checkoutTime);
          
          if (checkoutTimeObj <= checkinTime) {
            showToast('Check-out time must be after check-in time', 'error');
            return;
          }
          
          const hoursWorked = (checkoutTimeObj - checkinTime) / (1000 * 60 * 60);
          const expectedHours = 9; // 9-hour shift
          const overtime = Math.max(0, hoursWorked - expectedHours);
          
          attendance[empId][today] = {
            ...todayAttendance,
            checkout: checkoutTime,
            hoursWorked: Math.round(hoursWorked * 100) / 100,
            overtime: Math.round(overtime * 100) / 100,
            biometricId: biometricId || todayAttendance.biometricId,
            notes: notes || todayAttendance.notes
          };
          
          saveAttendance(attendance);
          closeModal();
          renderStaff();
          updateStaffStats();
          showToast(`${emp.name} checked out successfully. Hours worked: ${Math.round(hoursWorked * 100) / 100}`, 'success');
        }}
      ]);
      
      // Set default check-out time to now
      setTimeout(() => {
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        const checkoutInput = document.getElementById('checkoutTime');
        if (checkoutInput) {
          checkoutInput.value = localDateTime;
        }
      }, 100);
    }

    function getShiftStartTime(shiftName) {
      const shift = SHIFT_TYPES.find(s => s.name === shiftName);
      return shift ? shift.start : '09:00';
    }

    function getShiftEndTime(shiftName) {
      const shift = SHIFT_TYPES.find(s => s.name === shiftName);
      return shift ? shift.end : '18:00';
    }

    function calculateHoursWorked(checkinTime) {
      const now = new Date();
      const checkin = new Date(checkinTime);
      const hours = (now - checkin) / (1000 * 60 * 60);
      return Math.round(hours * 100) / 100;
    }

    function updateStaffStats() {
      const staff = loadStaff();
      const attendance = loadAttendance();
      const leaveRequests = loadLeaveRequests();
      const today = new Date().toISOString().slice(0, 10);
      
      const totalStaff = staff.length;
      const presentToday = staff.filter(emp => {
        const todayAttendance = attendance[emp.id]?.[today];
        return todayAttendance && todayAttendance.status === 'P';
      }).length;
      const onLeave = staff.filter(emp => emp.status === 'On Leave').length;
      const pendingLeave = leaveRequests.filter(req => req.status === 'Pending').length;
      
      const totalStaffEl = document.getElementById('totalStaffCount');
      const presentTodayEl = document.getElementById('presentTodayCount');
      const onLeaveEl = document.getElementById('onLeaveCount');
      const pendingLeaveEl = document.getElementById('pendingLeaveCount');
      
      if (totalStaffEl) totalStaffEl.textContent = totalStaff;
      if (presentTodayEl) presentTodayEl.textContent = presentToday;
      if (onLeaveEl) onLeaveEl.textContent = onLeave;
      if (pendingLeaveEl) pendingLeaveEl.textContent = pendingLeave;
    }

    function editStaff(empId) {
      const staff = loadStaff();
      const emp = staff.find(s => s.id === empId);
      if (!emp) return;
      
      const body = `
        <div class="form-group">
          <label>Full Name *</label>
          <input id="editStaffName" type="text" value="${emp.name}" required />
        </div>
        <div class="form-group">
          <label>Role *</label>
          <select id="editStaffRole" required>
            <option value="">Select role...</option>
            ${STAFF_ROLES.map(role => `<option value="${role}" ${emp.role === role ? 'selected' : ''}>${role}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Department *</label>
          <select id="editStaffDepartment" required>
            <option value="">Select department...</option>
            ${STAFF_DEPARTMENTS.map(dept => `<option value="${dept}" ${emp.dept === dept ? 'selected' : ''}>${dept}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Shift *</label>
          <select id="editStaffShift" required>
            <option value="">Select shift...</option>
            ${SHIFT_TYPES.map(shift => `<option value="${shift.name}" ${emp.shift === shift.name ? 'selected' : ''}>${shift.name} (${shift.start} - ${shift.end})</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Contact Number *</label>
          <input id="editStaffContact" type="tel" value="${emp.contact}" required />
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input id="editStaffEmail" type="email" value="${emp.email || ''}" />
        </div>
        <div class="form-group">
          <label>Address</label>
          <textarea id="editStaffAddress" rows="3">${emp.address || ''}</textarea>
        </div>
        <div class="form-group">
          <label>Join Date *</label>
          <input id="editStaffJoinDate" type="date" value="${emp.join}" required />
        </div>
        <div class="form-group">
          <label>Basic Salary (INR) *</label>
          <input id="editStaffSalary" type="number" min="0" value="${emp.salary || 0}" required />
        </div>
        <div class="form-group">
          <label>Emergency Contact</label>
          <input id="editStaffEmergencyContact" type="tel" value="${emp.emergencyContact || ''}" />
        </div>
        <div class="form-group">
          <label>Status *</label>
          <select id="editStaffStatus" required>
            <option value="Active" ${emp.status === 'Active' ? 'selected' : ''}>Active</option>
            <option value="On Leave" ${emp.status === 'On Leave' ? 'selected' : ''}>On Leave</option>
            <option value="Inactive" ${emp.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
          </select>
        </div>
      `;
      
      openModal('Edit Staff Member', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Update Staff', type: 'primary', action: () => {
          const name = document.getElementById('editStaffName').value.trim();
          const role = document.getElementById('editStaffRole').value;
          const department = document.getElementById('editStaffDepartment').value;
          const shift = document.getElementById('editStaffShift').value;
          const contact = document.getElementById('editStaffContact').value.trim();
          const email = document.getElementById('editStaffEmail').value.trim();
          const address = document.getElementById('editStaffAddress').value.trim();
          const joinDate = document.getElementById('editStaffJoinDate').value;
          const salary = parseInt(document.getElementById('editStaffSalary').value, 10);
          const emergencyContact = document.getElementById('editStaffEmergencyContact').value.trim();
          const status = document.getElementById('editStaffStatus').value;
          
          if (!name || !role || !department || !shift || !contact || !joinDate || isNaN(salary) || salary <= 0 || !status) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const staffIndex = staff.findIndex(s => s.id === empId);
          if (staffIndex === -1) return;
          
          staff[staffIndex] = {
            ...staff[staffIndex],
            name,
            role,
            dept: department,
            shift: shift,
            contact,
            email: email || 'N/A',
            address: address || 'N/A',
            join: joinDate,
            salary,
            emergencyContact: emergencyContact || 'N/A',
            status,
            updatedAt: new Date().toISOString()
          };
          
          saveStaff(staff);
          closeModal();
          renderStaff();
          updateStaffStats();
          showToast(`Staff member ${name} updated successfully`, 'success');
        }}
      ]);
    }

    function deleteStaff(empId) {
      const staff = loadStaff();
      const emp = staff.find(s => s.id === empId);
      if (!emp) return;
      
      confirmModal('Delete Staff Member', `Are you sure you want to delete ${emp.name} (${empId})? This action cannot be undone.`, () => {
        const filtered = staff.filter(s => s.id !== empId);
        saveStaff(filtered);
        renderStaff();
        updateStaffStats();
        showToast(`Staff member ${emp.name} deleted successfully`, 'success');
      });
    }

    function approveLeave(leaveId) {
      const leaveRequests = loadLeaveRequests();
      const requestIndex = leaveRequests.findIndex(req => req.id === leaveId);
      if (requestIndex === -1) return;
      
      leaveRequests[requestIndex].status = 'Approved';
      leaveRequests[requestIndex].approvedAt = new Date().toISOString();
      saveLeaveRequests(leaveRequests);
      
      // Update staff status if needed
      const staff = loadStaff();
      const staffIndex = staff.findIndex(s => s.id === leaveRequests[requestIndex].employeeId);
      if (staffIndex !== -1) {
        staff[staffIndex].status = 'On Leave';
        saveStaff(staff);
      }
      
      showToast('Leave request approved successfully', 'success');
      viewLeaveRequests();
    }

    function rejectLeave(leaveId) {
      const leaveRequests = loadLeaveRequests();
      const requestIndex = leaveRequests.findIndex(req => req.id === leaveId);
      if (requestIndex === -1) return;
      
      leaveRequests[requestIndex].status = 'Rejected';
      leaveRequests[requestIndex].rejectedAt = new Date().toISOString();
      saveLeaveRequests(leaveRequests);
      
      showToast('Leave request rejected', 'success');
      viewLeaveRequests();
    }

    function viewLeaveDetails(leaveId) {
      const leaveRequests = loadLeaveRequests();
      const staff = loadStaff();
      const request = leaveRequests.find(req => req.id === leaveId);
      if (!request) return;
      
      const emp = staff.find(s => s.id === request.employeeId);
      const days = Math.ceil((new Date(request.endDate) - new Date(request.startDate)) / (1000 * 60 * 60 * 24)) + 1;
      
      const html = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem;">Request ID</div>
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--brand-600);">${request.id}</div>
          </div>
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem;">Status</div>
            <div><span class="${leaveBadgeClass(request.status)}">${request.status}</span></div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Employee Information</div>
          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${emp ? emp.name : 'Unknown'}</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><strong>Employee ID:</strong> ${request.employeeId}</div>
            <div><strong>Department:</strong> ${emp ? emp.dept : 'N/A'}</div>
            <div><strong>Role:</strong> ${emp ? emp.role : 'N/A'}</div>
            <div><strong>Contact:</strong> ${emp ? emp.contact : 'N/A'}</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Leave Details</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><strong>Leave Type:</strong> ${request.type}</div>
            <div><strong>Start Date:</strong> ${request.startDate}</div>
            <div><strong>End Date:</strong> ${request.endDate}</div>
            <div><strong>Total Days:</strong> ${days}</div>
            <div><strong>Reason:</strong> ${request.reason || 'N/A'}</div>
            <div><strong>Applied On:</strong> ${request.appliedAt || 'N/A'}</div>
          </div>
        </div>
        
        ${request.notes ? `
          <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Additional Notes</div>
            <div style="font-size: 0.9rem; color: var(--gray-600);">${request.notes}</div>
          </div>
        ` : ''}
      `;
      
      openModal('Leave Request Details', html, [
        { label: 'Close', type: 'secondary', action: closeModal }
      ], 'large');
    }

    function exportAttendanceReport() {
      const staff = loadStaff();
      const attendance = loadAttendance();
      const currentMonth = new Date().toISOString().slice(0, 7);
      
      let csvContent = "Employee ID,Name,Department,Weekly Present,Weekly Absent,Monthly Present,Monthly Absent,Attendance %\n";
      
      staff.forEach(emp => {
        const empAttendance = attendance[emp.id] || {};
        const days = Object.keys(empAttendance).filter(d => d.startsWith(currentMonth));
        const present = days.filter(d => empAttendance[d] === 'P').length;
        const absent = days.filter(d => empAttendance[d] === 'A').length;
        
        // Weekly stats (last 7 days)
        const weekDays = Object.keys(empAttendance).filter(d => {
          const date = new Date(d);
          const today = new Date();
          const diffTime = today - date;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays <= 7;
        });
        const weekPresent = weekDays.filter(d => empAttendance[d] === 'P').length;
        const weekAbsent = weekDays.filter(d => empAttendance[d] === 'A').length;
        
        const weeklyPercent = weekDays.length > 0 ? Math.round((weekPresent / weekDays.length) * 100) : 0;
        const monthlyPercent = days.length > 0 ? Math.round((present / days.length) * 100) : 0;
        const avgPercent = Math.round((weeklyPercent + monthlyPercent) / 2);
        
        csvContent += `${emp.id},${emp.name},${emp.dept},${weekPresent},${weekAbsent},${present},${absent},${avgPercent}%\n`;
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `attendance_report_${currentMonth}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      showToast('Attendance report exported successfully', 'success');
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.altKey) {
        switch(e.key) {
          case '1': showScreen('orders'); break;
          case '2': showScreen('stock'); break;
          case '3': showScreen('inventory'); break;
          case '4': showScreen('staff'); break;
          case '5': showScreen('billing'); break;
          case '6': showScreen('gst'); break;
          case 'h': backToDashboard(); break;
        }
      }
    });

    // --------------------
    // Orders: Mock Data + UI
    // --------------------
    const cncMaterials = [
      { code: 'AL-6061', name: 'Aluminum 6061-T6' },
      { code: 'ST-304', name: 'Stainless Steel 304' },
      { code: 'BR-C360', name: 'Brass C360' },
      { code: 'ABS', name: 'ABS Plastic' },
      { code: 'POM', name: 'POM (Delrin/Acetal)' }
    ];

    // --------------------
    // Stock Management: Data + UI
    // --------------------
    const STOCK_STORAGE_KEY = 'logosic_stock_v1';
    const STOCK_CATEGORIES = ['Electronics', 'Furniture', 'Medical', 'Industrial', 'Automotive', 'Textiles', 'Food & Beverage', 'Other'];

    function loadStock() {
      try {
        const raw = localStorage.getItem(STOCK_STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch (_) {}
      const seeded = [
        { id: 'ELE-001', name: 'Samsung Galaxy Smartphone', category: 'Electronics', currentStock: 45, minRequired: 20, unitPrice: 25999, status: 'In Stock', supplier: 'Samsung India', lastUpdated: '2025-09-01' },
        { id: 'FUR-002', name: 'Office Chair Premium', category: 'Furniture', currentStock: 8, minRequired: 15, unitPrice: 12499, status: 'Low Stock', supplier: 'Furniture Co', lastUpdated: '2025-08-28' },
        { id: 'MED-003', name: 'Digital Thermometer', category: 'Medical', currentStock: 120, minRequired: 50, unitPrice: 899, status: 'In Stock', supplier: 'MedTech Ltd', lastUpdated: '2025-09-05' },
        { id: 'IND-004', name: 'Industrial Drill Machine', category: 'Industrial', currentStock: 0, minRequired: 10, unitPrice: 45000, status: 'Out of Stock', supplier: 'Industrial Tools', lastUpdated: '2025-08-15' },
        { id: 'ELE-005', name: 'Laptop Dell Inspiron', category: 'Electronics', currentStock: 32, minRequired: 25, unitPrice: 55999, status: 'In Stock', supplier: 'Dell India', lastUpdated: '2025-09-03' }
      ];
      saveStock(seeded);
      return seeded;
    }

    function saveStock(stock) {
      localStorage.setItem(STOCK_STORAGE_KEY, JSON.stringify(stock));
    }

    function generateStockId(category, existing) {
      const categoryPrefix = category.substring(0, 3).toUpperCase();
      let max = 0;
      existing.forEach(item => {
        if (item.id.startsWith(categoryPrefix)) {
          const n = parseInt(item.id.replace(/[^0-9]/g, ''), 10);
          if (!isNaN(n)) max = Math.max(max, n);
        }
      });
      const next = String(max + 1).padStart(3, '0');
      return `${categoryPrefix}-${next}`;
    }

    function getStockStatus(currentStock, minRequired) {
      if (currentStock === 0) return 'Out of Stock';
      if (currentStock <= minRequired) return 'Low Stock';
      return 'In Stock';
    }

    function stockBadgeClass(status) {
      switch ((status || '').toLowerCase()) {
        case 'in stock': return 'status-badge status-active';
        case 'low stock': return 'status-badge status-pending';
        case 'out of stock': return 'status-badge status-cancelled';
        default: return 'status-badge status-pending';
      }
    }

    const ORDERS_STORAGE_KEY = 'logosic_orders_v1';

    function loadOrders() {
      try {
        const raw = localStorage.getItem(ORDERS_STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch (_) {}
      // Seed with initial mock rows
      const seeded = [
        { id: 'ORD-001', customer: 'Rajesh Kumar', items: 'Electronics Package', amount: 15499, status: 'Shipped', date: '2025-09-05' },
        { id: 'ORD-002', customer: 'Priya Sharma', items: 'Furniture Set', amount: 48999, status: 'Pending', date: '2025-09-06' },
        { id: 'ORD-003', customer: 'Amit Patel', items: 'Medical Supplies', amount: 8750, status: 'Completed', date: '2025-09-04' },
        { id: 'ORD-004', customer: 'Sneha Reddy', items: 'Home Appliances', amount: 32199, status: 'Shipped', date: '2025-09-07' },
        { id: 'ORD-005', customer: 'Vikram Singh', items: 'Industrial Equipment', amount: 125000, status: 'Pending', date: '2025-09-08' }
      ];
      saveOrders(seeded);
      return seeded;
    }

    function saveOrders(orders) {
      localStorage.setItem(ORDERS_STORAGE_KEY, JSON.stringify(orders));
    }

    function refreshDashboardStats() {
      const orders = loadOrders();
      const totalOrdersEl = document.getElementById('totalOrdersCount');
      if (totalOrdersEl) totalOrdersEl.textContent = orders.length;
    }

    function formatINR(amount) {
      try {
        return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(amount);
      } catch (_) {
        return '₹' + amount;
      }
    }

    function statusBadgeClass(status) {
      switch ((status || '').toLowerCase()) {
        case 'pending': return 'status-badge status-pending';
        case 'completed': return 'status-badge status-completed';
        case 'shipped': return 'status-badge status-shipped';
        case 'cancelled': return 'status-badge status-cancelled';
        default: return 'status-badge status-pending';
      }
    }

    // --------------------
    // Billing: Invoices Store + UI
    // --------------------
    const INVOICES_STORAGE_KEY = 'logosic_invoices_v1';

    function loadInvoices() {
      try {
        const raw = localStorage.getItem(INVOICES_STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch (_) {}
      const seeded = [
        { id: 'INV-2025-001', customer: 'Tech Solutions Pvt Ltd', amount: 125999, issueDate: '2025-08-15', dueDate: '2025-09-15', status: 'Paid', items: [{ name: 'Logistics Services', qty: 1, price: 125999 }] },
        { id: 'INV-2025-002', customer: 'Global Enterprises', amount: 89450, issueDate: '2025-08-20', dueDate: '2025-09-20', status: 'Unpaid', items: [{ name: 'Freight Handling', qty: 1, price: 89450 }] },
        { id: 'INV-2025-003', customer: 'Medical Supplies Inc', amount: 67800, issueDate: '2025-09-01', dueDate: '2025-10-01', status: 'Paid', items: [{ name: 'Cold Chain Transport', qty: 1, price: 67800 }] },
        { id: 'INV-2025-004', customer: 'Industrial Motors Ltd', amount: 245000, issueDate: '2025-07-28', dueDate: '2025-08-28', status: 'Overdue', items: [{ name: 'Bulk Shipment', qty: 1, price: 245000 }] },
        { id: 'INV-2025-005', customer: 'Retail Chain Stores', amount: 156750, issueDate: '2025-09-05', dueDate: '2025-10-05', status: 'Unpaid', items: [{ name: 'Warehousing', qty: 1, price: 156750 }] }
      ];
      saveInvoices(seeded);
      return seeded;
    }

    function saveInvoices(invoices) {
      localStorage.setItem(INVOICES_STORAGE_KEY, JSON.stringify(invoices));
    }

    function invoiceBadgeClass(status) {
      const s = (status || '').toLowerCase();
      if (s === 'paid') return 'status-badge status-paid';
      if (s === 'unpaid') return 'status-badge status-unpaid';
      if (s === 'overdue') return 'status-badge status-cancelled';
      return 'status-badge status-pending';
    }

    function renderInvoices() {
      const tbody = document.getElementById('billingTbody');
      if (!tbody) return;
      const invoices = loadInvoices();
      tbody.innerHTML = invoices.map(inv => {
        const dropdownId = `billingDropdown_${inv.id}`;
        const actions = `
          <div class="dropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown('${dropdownId}')">
              <i class="pi pi-ellipsis-v"></i> Actions
            </button>
            <div class="dropdown-menu" id="${dropdownId}">
              <a class="dropdown-item" onclick="viewInvoice('${inv.id}', event); closeAllDropdowns();">
                <i class="pi pi-eye"></i> View Invoice
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="printInvoice('${inv.id}', event); closeAllDropdowns();">
                <i class="pi pi-print"></i> Print Invoice
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="deleteInvoice('${inv.id}', event); closeAllDropdowns();" style="color: var(--error-500);">
                <i class="pi pi-trash"></i> Delete Invoice
              </a>
            </div>
          </div>
        `;
        return `
        <tr>
          <td><strong>${inv.id}</strong></td>
          <td>${inv.customer}</td>
          <td>${formatINR(inv.amount)}</td>
          <td>${inv.issueDate}</td>
          <td>${inv.dueDate}</td>
          <td><span class="${invoiceBadgeClass(inv.status)}">${inv.status}</span></td>
            <td>${actions}</td>
        </tr>
        `;
      }).join('');
    }

    function generateInvoiceId(list) {
      let max = 0;
      list.forEach(i => { const n = parseInt((i.id || '').replace(/[^0-9]/g, ''), 10); if (!isNaN(n)) max = Math.max(max, n); });
      const next = String(max + 1).padStart(3, '0');
      const year = new Date().getFullYear();
      return `INV-${year}-${next}`;
    }

    function openCreateInvoiceModal() {
      const body = `
        <div class="form-group"><label>Customer</label><input id="invCustomer" type="text" placeholder="Company or person" /></div>
        <div class="form-group"><label>Issue Date</label><input id="invIssue" type="date" /></div>
        <div class="form-group"><label>Due Date</label><input id="invDue" type="date" /></div>
        <div class="form-group"><label>Item Description</label><input id="invItem" type="text" placeholder="Service / Item" /></div>
        <div class="form-group"><label>Quantity</label><input id="invQty" type="number" min="1" value="1" /></div>
        <div class="form-group"><label>Unit Price (INR)</label><input id="invPrice" type="number" min="1" /></div>
      `;
      openModal('Create Invoice', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Create', type: 'primary', action: () => {
          const customer = document.getElementById('invCustomer').value.trim();
          const issueDate = document.getElementById('invIssue').value;
          const dueDate = document.getElementById('invDue').value;
          const item = document.getElementById('invItem').value.trim();
          const qty = parseInt(document.getElementById('invQty').value, 10) || 1;
          const price = parseInt(document.getElementById('invPrice').value, 10) || 0;
          if (!customer || !issueDate || !dueDate || !item || price <= 0) { showToast('Please fill all fields correctly', 'error'); return; }
          const invoices = loadInvoices();
          const id = generateInvoiceId(invoices);
          const amount = qty * price;
          const inv = { id, customer, amount, issueDate, dueDate, status: 'Unpaid', items: [{ name: item, qty, price }] };
          invoices.unshift(inv);
          saveInvoices(invoices);
          closeModal();
          renderInvoices();
          showToast('Invoice created', 'success');
        }}
      ]);
    }

    function viewInvoice(id, evt) {
      if (evt) evt.stopPropagation();
      const inv = loadInvoices().find(i => i.id === id);
      if (!inv) return;
      const lines = inv.items.map(it => `${it.name} — ${it.qty} × ${formatINR(it.price)} = ${formatINR(it.qty * it.price)}`);
      const html = `
        <div><strong>${inv.id}</strong></div>
        <div style="margin:.25rem 0 1rem 0; color:var(--gray-600)">${inv.customer}</div>
        <div><strong>Issue:</strong> ${inv.issueDate} &nbsp; • &nbsp; <strong>Due:</strong> ${inv.dueDate}</div>
        <div style="margin:.5rem 0"><strong>Amount:</strong> ${formatINR(inv.amount)}</div>
        <div style="margin:.5rem 0"><strong>Status:</strong> ${inv.status}</div>
        <div style="margin-top:.75rem">${lines.join('<br/>')}</div>
      `;
      openModal('Invoice', html, [
        { label: 'Close', type: 'secondary', action: closeModal },
        { label: 'Print', type: 'primary', action: () => { closeModal(); printInvoice(id); } }
      ]);
    }

    function deleteInvoice(id, evt) {
      if (evt) evt.stopPropagation();
      confirmModal('Delete Invoice', 'Are you sure you want to delete this invoice?', () => {
        let invoices = loadInvoices();
        invoices = invoices.filter(i => i.id !== id);
        saveInvoices(invoices);
        renderInvoices();
      });
    }

    function printInvoice(id, evt) {
      if (evt) evt.stopPropagation();
      const inv = loadInvoices().find(i => i.id === id);
      if (!inv) return;
      const company = 'Logosic Logistics';
      const address = '123 Industrial Park, Chennai, IN';
      const phone = '+91 98765 43210';
      const qrData = encodeURIComponent(`${inv.id}|${inv.customer}|${inv.amount}|${inv.issueDate}|${inv.dueDate}`);
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${qrData}`;
      const itemsRows = inv.items.map(it => `
        <tr>
          <td style="padding:8px;border:1px solid #e5e7eb">${it.name}</td>
          <td style="padding:8px;border:1px solid #e5e7eb;text-align:center">${it.qty}</td>
          <td style="padding:8px;border:1px solid #e5e7eb;text-align:right">${formatINR(it.price)}</td>
          <td style="padding:8px;border:1px solid #e5e7eb;text-align:right">${formatINR(it.qty * it.price)}</td>
        </tr>`).join('');
      const html = `
        <html><head><title>${inv.id}</title><meta charset="utf-8" />
        <link rel="stylesheet" href="https://unpkg.com/primeicons/primeicons.css" />
        <style>body{font-family:Inter,Segoe UI,Roboto,sans-serif;background:#f8fafc;color:#111827;margin:0;padding:24px}
        .invoice{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:24px;max-width:900px;margin:0 auto}
        .row{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
        .muted{color:#6b7280}
        h1{margin:0 0 8px 0;font-size:22px}
        table{border-collapse:collapse;width:100%;margin-top:16px}
        .totals{margin-top:12px;display:flex;justify-content:flex-end}
        .badge{display:inline-block;padding:2px 8px;border-radius:9999px;background:#ede9fe;color:#6d28d9;font-weight:600}
        </style></head><body>
        <div class="invoice">
          <div class="row">
            <div>
              <h1>${company}</h1>
              <div class="muted">${address}</div>
              <div class="muted">${phone}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700">Invoice</div>
              <div>${inv.id}</div>
              <div class="muted">Issue: ${inv.issueDate} • Due: ${inv.dueDate}</div>
              <div class="badge" style="margin-top:6px">${inv.status}</div>
            </div>
          </div>
          <hr style="margin:16px 0;border:none;border-top:1px solid #e5e7eb"/>
          <div class="row">
            <div>
              <div style="font-weight:700;margin-bottom:4px">Bill To</div>
              <div>${inv.customer}</div>
            </div>
            <img src="${qrUrl}" width="120" height="120" alt="QR"/>
          </div>
          <table>
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;border:1px solid #e5e7eb;background:#f9fafb">Description</th>
                <th style="text-align:center;padding:8px;border:1px solid #e5e7eb;background:#f9fafb">Qty</th>
                <th style="text-align:right;padding:8px;border:1px solid #e5e7eb;background:#f9fafb">Unit Price</th>
                <th style="text-align:right;padding:8px;border:1px solid #e5e7eb;background:#f9fafb">Line Total</th>
              </tr>
            </thead>
            <tbody>${itemsRows}</tbody>
          </table>
          <div class="totals"><div>
            <div style="display:flex;gap:24px;justify-content:flex-end"><div class="muted">Subtotal</div><div>${formatINR(inv.amount)}</div></div>
            <div style="display:flex;gap:24px;justify-content:flex-end"><div class="muted">GST (18%)</div><div>${formatINR(Math.round(inv.amount*0.18))}</div></div>
            <hr style="margin:8px 0;border:none;border-top:1px solid #e5e7eb"/>
            <div style="display:flex;gap:24px;justify-content:flex-end;font-weight:700"><div>Total</div><div>${formatINR(Math.round(inv.amount*1.18))}</div></div>
          </div></div>
          <div class="muted" style="margin-top:16px">Thank you for your business.</div>
        </div>
        <script>window.onload=()=>{window.print();setTimeout(()=>window.close(),300)}<\/script>
        </body></html>`;
      const w = window.open('', '_blank');
      if (!w) { showToast('Popup blocked. Please allow popups to print.', 'error'); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    function renderOrders() {
      const tbody = document.getElementById('ordersTbody');
      if (!tbody) return;
      const orders = loadOrders();
      
      // Get filter values
      const statusFilter = document.getElementById('statusFilter')?.value || '';
      const startEl = document.getElementById('orderDateStart');
      const endEl = document.getElementById('orderDateEnd');
      const searchEl = document.getElementById('searchOrders');
      const sortEl = document.getElementById('sortOrders');
      
      const startVal = startEl && startEl.value ? new Date(startEl.value) : null;
      const endVal = endEl && endEl.value ? new Date(endEl.value) : null;
      const searchTerm = searchEl ? searchEl.value.toLowerCase() : '';
      const sortBy = sortEl ? sortEl.value : 'date-desc';
      
      // Apply filters
      let filtered = orders.filter(o => {
        // Status filter
        if (statusFilter && o.status !== statusFilter) return false;
        
        // Date range filter
        const od = new Date(o.date);
        if (startVal && od < startVal) return false;
        if (endVal && od > endVal) return false;
        
        // Search filter
        if (searchTerm) {
          const searchText = `${o.id} ${o.customer} ${o.items} ${o.meta?.materialCode || ''}`.toLowerCase();
          if (!searchText.includes(searchTerm)) return false;
        }
        
        return true;
      });
      
      // Apply sorting
      filtered.sort((a, b) => {
        switch (sortBy) {
          case 'date-desc':
            return new Date(b.date) - new Date(a.date);
          case 'date-asc':
            return new Date(a.date) - new Date(b.date);
          case 'amount-desc':
            return b.amount - a.amount;
          case 'amount-asc':
            return a.amount - b.amount;
          case 'customer':
            return a.customer.localeCompare(b.customer);
          case 'status':
            return a.status.localeCompare(b.status);
          default:
            return 0;
        }
      });
      tbody.innerHTML = filtered.map(o => {
        const dropdownId = `orderDropdown_${o.id}`;
        const actions = `
          <div class="dropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown('${dropdownId}')">
              <i class="pi pi-ellipsis-v"></i> Actions
            </button>
            <div class="dropdown-menu" id="${dropdownId}">
              <a class="dropdown-item" onclick="viewOrder('${o.id}', event); closeAllDropdowns();">
                <i class="pi pi-eye"></i> View Details
              </a>
              <a class="dropdown-item" onclick="editOrder('${o.id}', event); closeAllDropdowns();">
                <i class="pi pi-pencil"></i> Edit Order
              </a>
              ${o.status === 'Pending' ? `
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" onclick="markOrderCompleted('${o.id}', event); closeAllDropdowns();">
                  <i class="pi pi-check"></i> Mark Complete
                </a>
              ` : ''}
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="deleteOrder('${o.id}', event); closeAllDropdowns();" style="color: var(--error-500);">
                <i class="pi pi-trash"></i> Delete Order
              </a>
            </div>
          </div>
        `;
        return `
          <tr>
            <td><strong>#${o.id}</strong></td>
            <td>${o.customer}</td>
            <td>${o.items}</td>
            <td>${formatINR(o.amount)}</td>
            <td><span class="${statusBadgeClass(o.status)}">${o.status}</span></td>
            <td>${o.date}</td>
            <td>${actions}</td>
          </tr>
        `;
      }).join('');
      
      // Update order statistics
      updateOrderStats(orders);
    }

    function updateOrderStats(orders) {
      const today = new Date().toISOString().slice(0, 10);
      const pendingCount = orders.filter(o => o.status === 'Pending').length;
      const completedToday = orders.filter(o => o.status === 'Completed' && o.date === today).length;
      const totalValue = orders.reduce((sum, o) => sum + o.amount, 0);
      const avgValue = orders.length > 0 ? Math.round(totalValue / orders.length) : 0;
      
      const pendingEl = document.getElementById('pendingOrdersCount');
      const completedEl = document.getElementById('completedOrdersCount');
      const totalValueEl = document.getElementById('totalOrdersValue');
      const avgValueEl = document.getElementById('avgOrderValue');
      
      if (pendingEl) pendingEl.textContent = pendingCount;
      if (completedEl) completedEl.textContent = completedToday;
      if (totalValueEl) totalValueEl.textContent = formatINR(totalValue);
      if (avgValueEl) avgValueEl.textContent = formatINR(avgValue);
    }

    function applyFilters() {
      renderOrders();
    }

    function generateOrderId(existing) {
      // Find max numeric suffix and increment
      let max = 0;
      existing.forEach(o => {
        const n = parseInt((o.id || '').replace(/[^0-9]/g, ''), 10);
        if (!isNaN(n)) max = Math.max(max, n);
      });
      const next = String(max + 1).padStart(3, '0');
      return `ORD-${next}`;
    }

    function receiveOrder() {
      const body = `
        <div class="form-group">
          <label>Customer Name *</label>
          <input id="orderCustomer" type="text" placeholder="Enter customer name" required />
        </div>
        <div class="form-group">
          <label>Material Type *</label>
          <select id="orderMaterial" required>
            <option value="">Select material...</option>
            ${cncMaterials.map((m, idx) => `<option value="${idx}">${m.name} (${m.code})</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Quantity *</label>
          <input id="orderQuantity" type="number" min="1" placeholder="Enter quantity" required />
        </div>
        <div class="form-group">
          <label>Unit Price (INR) *</label>
          <input id="orderPrice" type="number" min="1" placeholder="Enter unit price" required />
        </div>
        <div class="form-group">
          <label>Special Instructions</label>
          <textarea id="orderInstructions" placeholder="Any special requirements or notes..." rows="3"></textarea>
        </div>
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">Order Summary</div>
          <div id="orderSummary" style="color: var(--gray-600); font-size: 0.875rem;">Fill in the details above to see summary</div>
        </div>
      `;
      
      openModal('Create New Order', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Create Order', type: 'primary', action: () => {
          const customer = document.getElementById('orderCustomer').value.trim();
          const materialIdx = parseInt(document.getElementById('orderMaterial').value, 10);
          const quantity = parseInt(document.getElementById('orderQuantity').value, 10);
          const unitPrice = parseInt(document.getElementById('orderPrice').value, 10);
          const instructions = document.getElementById('orderInstructions').value.trim();
          
          if (!customer || isNaN(materialIdx) || isNaN(quantity) || isNaN(unitPrice) || quantity <= 0 || unitPrice <= 0) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const material = cncMaterials[materialIdx];
          if (!material) {
            showToast('Invalid material selection', 'error');
            return;
          }
          
          const orders = loadOrders();
      const id = generateOrderId(orders);
      const today = new Date().toISOString().slice(0, 10);
          const totalAmount = unitPrice * quantity;
          
      const newOrder = {
        id,
        customer,
        items: `${material.name} • ${quantity} units`,
            amount: totalAmount,
        status: 'Pending',
        date: today,
            meta: { 
              materialCode: material.code, 
              quantity, 
              unitPrice,
              instructions: instructions || 'None'
            }
          };
          
      orders.unshift(newOrder);
      saveOrders(orders);
          closeModal();
      renderOrders();
      refreshDashboardStats();
          showToast(`Order ${id} created successfully`, 'success');
        }}
      ]);
      
      // Add real-time calculation for order summary
      const updateSummary = () => {
        const materialIdx = parseInt(document.getElementById('orderMaterial').value, 10);
        const quantity = parseInt(document.getElementById('orderQuantity').value, 10);
        const unitPrice = parseInt(document.getElementById('orderPrice').value, 10);
        
        if (materialIdx >= 0 && quantity > 0 && unitPrice > 0) {
          const material = cncMaterials[materialIdx];
          const total = quantity * unitPrice;
          document.getElementById('orderSummary').innerHTML = `
            <strong>${material.name}</strong><br/>
            Quantity: ${quantity} units × ${formatINR(unitPrice)} = <strong>${formatINR(total)}</strong>
          `;
        } else {
          document.getElementById('orderSummary').textContent = 'Fill in the details above to see summary';
        }
      };
      
      // Add event listeners for real-time updates
      setTimeout(() => {
        const materialSelect = document.getElementById('orderMaterial');
        const quantityInput = document.getElementById('orderQuantity');
        const priceInput = document.getElementById('orderPrice');
        
        if (materialSelect) materialSelect.addEventListener('change', updateSummary);
        if (quantityInput) quantityInput.addEventListener('input', updateSummary);
        if (priceInput) priceInput.addEventListener('input', updateSummary);
      }, 100);
    }

    function markOrderCompleted(orderId, evt) {
      if (evt) evt.stopPropagation();
      const orders = loadOrders();
      const idx = orders.findIndex(o => o.id === orderId);
      if (idx === -1) return;
      orders[idx].status = 'Completed';
      saveOrders(orders);
      renderOrders();
      refreshDashboardStats();
    }

    function deleteOrder(orderId, evt) {
      if (evt) evt.stopPropagation();
      confirmModal('Delete Order', 'Are you sure you want to delete this order?', () => {
        let orders = loadOrders();
        orders = orders.filter(o => o.id !== orderId);
        saveOrders(orders);
        renderOrders();
        refreshDashboardStats();
      });
    }

    function viewOrder(orderId, evt) {
      if (evt) evt.stopPropagation();
      const orders = loadOrders();
      const o = orders.find(x => x.id === orderId);
      if (!o) return;
      
      const statusBadge = `<span class="${statusBadgeClass(o.status)}">${o.status}</span>`;
      const instructions = o.meta?.instructions || 'None';
      
      const html = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem;">Order ID</div>
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--brand-600);">#${o.id}</div>
          </div>
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem;">Status</div>
            <div>${statusBadge}</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Customer Information</div>
          <div style="font-size: 1.1rem; font-weight: 600;">${o.customer}</div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Order Details</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><strong>Material:</strong> ${o.meta?.materialCode || 'N/A'}</div>
            <div><strong>Quantity:</strong> ${o.meta?.quantity || 'N/A'} units</div>
            <div><strong>Unit Price:</strong> ${o.meta?.unitPrice ? formatINR(o.meta.unitPrice) : 'N/A'}</div>
            <div><strong>Total Amount:</strong> ${formatINR(o.amount)}</div>
            <div><strong>Order Date:</strong> ${o.date}</div>
            <div><strong>Items:</strong> ${o.items}</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Special Instructions</div>
          <div style="font-size: 0.9rem; color: var(--gray-600);">${instructions}</div>
        </div>
      `;
      
      const buttons = [
        { label: 'Close', type: 'secondary', action: closeModal }
      ];
      
      if (o.status === 'Pending') {
        buttons.push({ 
          label: 'Mark Complete', 
          type: 'primary', 
          action: () => { 
            closeModal(); 
            markOrderCompleted(orderId); 
          } 
        });
      }
      
      buttons.push({ 
        label: 'Edit Order', 
        type: 'secondary', 
        action: () => { 
          closeModal(); 
          editOrder(orderId); 
        } 
      });
      
      openModal('Order Details', html, buttons, 'large');
    }

    function editOrder(orderId) {
      const orders = loadOrders();
      const order = orders.find(o => o.id === orderId);
      if (!order) return;
      
      const body = `
        <div class="form-group">
          <label>Customer Name *</label>
          <input id="editCustomer" type="text" value="${order.customer}" required />
        </div>
        <div class="form-group">
          <label>Material Type *</label>
          <select id="editMaterial" required>
            <option value="">Select material...</option>
            ${cncMaterials.map((m, idx) => 
              `<option value="${idx}" ${order.meta?.materialCode === m.code ? 'selected' : ''}>${m.name} (${m.code})</option>`
            ).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Quantity *</label>
          <input id="editQuantity" type="number" min="1" value="${order.meta?.quantity || 1}" required />
        </div>
        <div class="form-group">
          <label>Unit Price (INR) *</label>
          <input id="editPrice" type="number" min="1" value="${order.meta?.unitPrice || 0}" required />
        </div>
        <div class="form-group">
          <label>Status *</label>
          <select id="editStatus" required>
            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
            <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
            <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
            <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
          </select>
        </div>
        <div class="form-group">
          <label>Special Instructions</label>
          <textarea id="editInstructions" placeholder="Any special requirements or notes..." rows="3">${order.meta?.instructions || ''}</textarea>
        </div>
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">Order Summary</div>
          <div id="editSummary" style="color: var(--gray-600); font-size: 0.875rem;">Fill in the details above to see summary</div>
        </div>
      `;
      
      openModal('Edit Order', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Update Order', type: 'primary', action: () => {
          const customer = document.getElementById('editCustomer').value.trim();
          const materialIdx = parseInt(document.getElementById('editMaterial').value, 10);
          const quantity = parseInt(document.getElementById('editQuantity').value, 10);
          const unitPrice = parseInt(document.getElementById('editPrice').value, 10);
          const status = document.getElementById('editStatus').value;
          const instructions = document.getElementById('editInstructions').value.trim();
          
          if (!customer || isNaN(materialIdx) || isNaN(quantity) || isNaN(unitPrice) || quantity <= 0 || unitPrice <= 0) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const material = cncMaterials[materialIdx];
          if (!material) {
            showToast('Invalid material selection', 'error');
            return;
          }
          
          const orderIndex = orders.findIndex(o => o.id === orderId);
          if (orderIndex === -1) return;
          
          const totalAmount = unitPrice * quantity;
          
          orders[orderIndex] = {
            ...orders[orderIndex],
            customer,
            items: `${material.name} • ${quantity} units`,
            amount: totalAmount,
            status,
            meta: { 
              materialCode: material.code, 
              quantity, 
              unitPrice,
              instructions: instructions || 'None'
            }
          };
          
          saveOrders(orders);
          closeModal();
          renderOrders();
          refreshDashboardStats();
          showToast(`Order ${orderId} updated successfully`, 'success');
        }}
      ]);
      
      // Add real-time calculation for edit summary
      const updateEditSummary = () => {
        const materialIdx = parseInt(document.getElementById('editMaterial').value, 10);
        const quantity = parseInt(document.getElementById('editQuantity').value, 10);
        const unitPrice = parseInt(document.getElementById('editPrice').value, 10);
        
        if (materialIdx >= 0 && quantity > 0 && unitPrice > 0) {
          const material = cncMaterials[materialIdx];
          const total = quantity * unitPrice;
          document.getElementById('editSummary').innerHTML = `
            <strong>${material.name}</strong><br/>
            Quantity: ${quantity} units × ${formatINR(unitPrice)} = <strong>${formatINR(total)}</strong>
          `;
        } else {
          document.getElementById('editSummary').textContent = 'Fill in the details above to see summary';
        }
      };
      
      // Add event listeners for real-time updates
      setTimeout(() => {
        const materialSelect = document.getElementById('editMaterial');
        const quantityInput = document.getElementById('editQuantity');
        const priceInput = document.getElementById('editPrice');
        
        if (materialSelect) materialSelect.addEventListener('change', updateEditSummary);
        if (quantityInput) quantityInput.addEventListener('input', updateEditSummary);
        if (priceInput) priceInput.addEventListener('input', updateEditSummary);
        
        // Initial summary update
        updateEditSummary();
      }, 100);
    }

    // --------------------
    // Financial Management: Data + UI
    // --------------------
    const FINANCIAL_STORAGE_KEY = 'logosic_financial_v1';
    const FINANCIAL_TYPES = ['Machine EMI', 'Electric Bill', 'Transport Cost', 'Commission'];
    const PAYMENT_METHODS = ['Cash', 'Bank Transfer', 'Cheque', 'UPI', 'Credit Card', 'Other'];
    const PAYMENT_STATUS = ['Pending', 'Paid', 'Overdue', 'Cancelled'];

    function loadFinancialRecords() {
      try {
        const raw = localStorage.getItem(FINANCIAL_STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch (_) {}
      const seeded = [
        { id: 'FIN-001', type: 'Machine EMI', description: 'CNC Machine EMI - September 2025', amount: 45000, status: 'Paid', paymentMethod: 'Bank Transfer', reference: 'EMI-SEP-001', date: '2025-09-01', dueDate: '2025-09-05', notes: 'Monthly EMI for CNC Machine' },
        { id: 'FIN-002', type: 'Electric Bill', description: 'Factory Electricity Bill - August 2025', amount: 12500, status: 'Paid', paymentMethod: 'UPI', reference: 'EB-AUG-001', date: '2025-08-28', dueDate: '2025-09-15', notes: 'Monthly electricity consumption' },
        { id: 'FIN-003', type: 'Transport Cost', description: 'Delivery Vehicle Maintenance', amount: 8500, status: 'Paid', paymentMethod: 'Cash', reference: 'TRANS-001', date: '2025-09-03', dueDate: '2025-09-03', notes: 'Vehicle service and maintenance' },
        { id: 'FIN-004', type: 'Commission', description: 'Sales Commission - August 2025', amount: 25000, status: 'Paid', paymentMethod: 'Bank Transfer', reference: 'COMM-AUG-001', date: '2025-09-01', dueDate: '2025-09-01', notes: 'Monthly sales commission payout' },
        { id: 'FIN-005', type: 'Machine EMI', description: 'Laser Cutting Machine EMI - September 2025', amount: 32000, status: 'Pending', paymentMethod: 'Bank Transfer', reference: 'EMI-SEP-002', date: '2025-09-05', dueDate: '2025-09-10', notes: 'Monthly EMI for Laser Cutting Machine' }
      ];
      saveFinancialRecords(seeded);
      return seeded;
    }

    function saveFinancialRecords(records) {
      localStorage.setItem(FINANCIAL_STORAGE_KEY, JSON.stringify(records));
    }

    function generateFinancialId(existing) {
      let max = 0;
      existing.forEach(record => {
        const n = parseInt((record.id || '').replace(/[^0-9]/g, ''), 10);
        if (!isNaN(n)) max = Math.max(max, n);
      });
      const next = String(max + 1).padStart(3, '0');
      return `FIN-${next}`;
    }

    function financialBadgeClass(status) {
      switch ((status || '').toLowerCase()) {
        case 'paid': return 'status-badge status-paid';
        case 'pending': return 'status-badge status-pending';
        case 'overdue': return 'status-badge status-cancelled';
        case 'cancelled': return 'status-badge status-cancelled';
        default: return 'status-badge status-pending';
      }
    }

    // --------------------
    // Stock Management Functions
    // --------------------
    function renderStock() {
      const tbody = document.getElementById('stockTbody');
      if (!tbody) return;
      const stock = loadStock();
      
      // Get filter values
      const categoryFilter = document.getElementById('stockCategoryFilter')?.value || '';
      const levelFilter = document.getElementById('stockLevelFilter')?.value || '';
      const searchEl = document.getElementById('searchStockItems');
      const sortEl = document.getElementById('sortStockItems');
      
      const searchTerm = searchEl ? searchEl.value.toLowerCase() : '';
      const sortBy = sortEl ? sortEl.value : 'name';
      
      // Apply filters
      let filtered = stock.filter(item => {
        // Category filter
        if (categoryFilter && item.category !== categoryFilter) return false;
        
        // Stock level filter
        if (levelFilter && item.status !== levelFilter) return false;
        
        // Search filter
        if (searchTerm) {
          const searchText = `${item.id} ${item.name} ${item.category} ${item.supplier || ''}`.toLowerCase();
          if (!searchText.includes(searchTerm)) return false;
        }
        
        return true;
      });
      
      // Apply sorting
      filtered.sort((a, b) => {
        switch (sortBy) {
          case 'name':
            return a.name.localeCompare(b.name);
          case 'name-desc':
            return b.name.localeCompare(a.name);
          case 'stock-desc':
            return b.currentStock - a.currentStock;
          case 'stock-asc':
            return a.currentStock - b.currentStock;
          case 'price-desc':
            return b.unitPrice - a.unitPrice;
          case 'price-asc':
            return a.unitPrice - b.unitPrice;
          case 'category':
            return a.category.localeCompare(b.category);
          case 'status':
            return a.status.localeCompare(b.status);
          default:
            return 0;
        }
      });
      
      tbody.innerHTML = filtered.map(item => {
        const totalValue = item.currentStock * item.unitPrice;
        const dropdownId = `stockDropdown_${item.id}`;
        const actions = `
          <div class="dropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown('${dropdownId}')">
              <i class="pi pi-ellipsis-v"></i> Actions
            </button>
            <div class="dropdown-menu" id="${dropdownId}">
              <a class="dropdown-item" onclick="viewStockItem('${item.id}', event); closeAllDropdowns();">
                <i class="pi pi-eye"></i> View Details
              </a>
              <a class="dropdown-item" onclick="editStockItem('${item.id}', event); closeAllDropdowns();">
                <i class="pi pi-pencil"></i> Edit Item
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="adjustStock('${item.id}', event); closeAllDropdowns();">
                <i class="pi pi-plus"></i> Adjust Stock
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="deleteStockItem('${item.id}', event); closeAllDropdowns();" style="color: var(--error-500);">
                <i class="pi pi-trash"></i> Delete Item
              </a>
            </div>
          </div>
        `;
        
        return `
          <tr>
            <td><strong>${item.id}</strong></td>
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${item.currentStock}</td>
            <td>${item.minRequired}</td>
            <td>${formatINR(item.unitPrice)}</td>
            <td>${formatINR(totalValue)}</td>
            <td><span class="${stockBadgeClass(item.status)}">${item.status}</span></td>
            <td>${item.supplier || 'N/A'}</td>
            <td>${item.lastUpdated || 'N/A'}</td>
            <td>${actions}</td>
          </tr>
        `;
      }).join('');
      
      // Update stock statistics
      updateStockStats(stock);
    }

    function updateStockStats(stock) {
      const totalItems = stock.length;
      const lowStockCount = stock.filter(item => item.status === 'Low Stock').length;
      const outOfStockCount = stock.filter(item => item.status === 'Out of Stock').length;
      const totalValue = stock.reduce((sum, item) => sum + (item.currentStock * item.unitPrice), 0);
      
      const totalItemsEl = document.getElementById('totalItemsCount');
      const lowStockEl = document.getElementById('lowStockCount');
      const outOfStockEl = document.getElementById('outOfStockCount');
      const totalValueEl = document.getElementById('totalStockValue');
      
      if (totalItemsEl) totalItemsEl.textContent = totalItems;
      if (lowStockEl) lowStockEl.textContent = lowStockCount;
      if (outOfStockEl) outOfStockEl.textContent = outOfStockCount;
      if (totalValueEl) totalValueEl.textContent = formatINR(totalValue);
    }

    function applyStockFilters() {
      renderStock();
    }

    function addStockItem() {
      const body = `
        <div class="form-group">
          <label>Product Name *</label>
          <input id="stockName" type="text" placeholder="Enter product name" required />
        </div>
        <div class="form-group">
          <label>Category *</label>
          <select id="stockCategory" required>
            <option value="">Select category...</option>
            ${STOCK_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Current Stock *</label>
          <input id="stockCurrent" type="number" min="0" placeholder="Enter current stock quantity" required />
        </div>
        <div class="form-group">
          <label>Minimum Required *</label>
          <input id="stockMinRequired" type="number" min="1" placeholder="Enter minimum required stock" required />
        </div>
        <div class="form-group">
          <label>Unit Price (INR) *</label>
          <input id="stockPrice" type="number" min="1" placeholder="Enter unit price" required />
        </div>
        <div class="form-group">
          <label>Supplier</label>
          <input id="stockSupplier" type="text" placeholder="Enter supplier name" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="stockDescription" placeholder="Product description or notes..." rows="3"></textarea>
        </div>
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">Stock Summary</div>
          <div id="stockSummary" style="color: var(--gray-600); font-size: 0.875rem;">Fill in the details above to see summary</div>
        </div>
      `;
      
      openModal('Add Stock Item', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Add Item', type: 'primary', action: () => {
          const name = document.getElementById('stockName').value.trim();
          const category = document.getElementById('stockCategory').value;
          const currentStock = parseInt(document.getElementById('stockCurrent').value, 10);
          const minRequired = parseInt(document.getElementById('stockMinRequired').value, 10);
          const unitPrice = parseInt(document.getElementById('stockPrice').value, 10);
          const supplier = document.getElementById('stockSupplier').value.trim();
          const description = document.getElementById('stockDescription').value.trim();
          
          if (!name || !category || isNaN(currentStock) || isNaN(minRequired) || isNaN(unitPrice) || 
              currentStock < 0 || minRequired <= 0 || unitPrice <= 0) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const stock = loadStock();
          const id = generateStockId(category, stock);
          const status = getStockStatus(currentStock, minRequired);
          const today = new Date().toISOString().slice(0, 10);
          
          const newItem = {
            id,
            name,
            category,
            currentStock,
            minRequired,
            unitPrice,
            status,
            supplier: supplier || 'N/A',
            description: description || 'No description',
            lastUpdated: today
          };
          
          stock.unshift(newItem);
          saveStock(stock);
          closeModal();
          renderStock();
          showToast(`Stock item ${id} added successfully`, 'success');
        }}
      ]);
      
      // Add real-time calculation for stock summary
      const updateSummary = () => {
        const currentStock = parseInt(document.getElementById('stockCurrent').value, 10);
        const minRequired = parseInt(document.getElementById('stockMinRequired').value, 10);
        const unitPrice = parseInt(document.getElementById('stockPrice').value, 10);
        
        if (!isNaN(currentStock) && !isNaN(minRequired) && !isNaN(unitPrice) && 
            currentStock >= 0 && minRequired > 0 && unitPrice > 0) {
          const totalValue = currentStock * unitPrice;
          const status = getStockStatus(currentStock, minRequired);
          document.getElementById('stockSummary').innerHTML = `
            <strong>Status:</strong> ${status}<br/>
            <strong>Total Value:</strong> ${formatINR(totalValue)}<br/>
            <strong>Stock Level:</strong> ${currentStock} / ${minRequired} (${Math.round((currentStock/minRequired)*100)}%)
          `;
        } else {
          document.getElementById('stockSummary').textContent = 'Fill in the details above to see summary';
        }
      };
      
      // Add event listeners for real-time updates
      setTimeout(() => {
        const currentInput = document.getElementById('stockCurrent');
        const minInput = document.getElementById('stockMinRequired');
        const priceInput = document.getElementById('stockPrice');
        
        if (currentInput) currentInput.addEventListener('input', updateSummary);
        if (minInput) minInput.addEventListener('input', updateSummary);
        if (priceInput) priceInput.addEventListener('input', updateSummary);
      }, 100);
    }

    function viewStockItem(itemId, evt) {
      if (evt) evt.stopPropagation();
      const stock = loadStock();
      const item = stock.find(i => i.id === itemId);
      if (!item) return;
      
      const totalValue = item.currentStock * item.unitPrice;
      const stockPercentage = Math.round((item.currentStock / item.minRequired) * 100);
      const statusBadge = `<span class="${stockBadgeClass(item.status)}">${item.status}</span>`;
      
      const html = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem;">Item Code</div>
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--brand-600);">${item.id}</div>
          </div>
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem;">Status</div>
            <div>${statusBadge}</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Product Information</div>
          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${item.name}</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><strong>Category:</strong> ${item.category}</div>
            <div><strong>Supplier:</strong> ${item.supplier}</div>
            <div><strong>Unit Price:</strong> ${formatINR(item.unitPrice)}</div>
            <div><strong>Last Updated:</strong> ${item.lastUpdated}</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Stock Details</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><strong>Current Stock:</strong> ${item.currentStock} units</div>
            <div><strong>Min Required:</strong> ${item.minRequired} units</div>
            <div><strong>Total Value:</strong> ${formatINR(totalValue)}</div>
            <div><strong>Stock Level:</strong> ${stockPercentage}%</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Description</div>
          <div style="font-size: 0.9rem; color: var(--gray-600);">${item.description}</div>
        </div>
      `;
      
      openModal('Stock Item Details', html, [
        { label: 'Close', type: 'secondary', action: closeModal },
        { label: 'Edit Item', type: 'primary', action: () => { 
          closeModal(); 
          editStockItem(itemId); 
        } }
      ], 'large');
    }

    function editStockItem(itemId) {
      const stock = loadStock();
      const item = stock.find(i => i.id === itemId);
      if (!item) return;
      
      const body = `
        <div class="form-group">
          <label>Product Name *</label>
          <input id="editStockName" type="text" value="${item.name}" required />
        </div>
        <div class="form-group">
          <label>Category *</label>
          <select id="editStockCategory" required>
            <option value="">Select category...</option>
            ${STOCK_CATEGORIES.map(cat => 
              `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`
            ).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Current Stock *</label>
          <input id="editStockCurrent" type="number" min="0" value="${item.currentStock}" required />
        </div>
        <div class="form-group">
          <label>Minimum Required *</label>
          <input id="editStockMinRequired" type="number" min="1" value="${item.minRequired}" required />
        </div>
        <div class="form-group">
          <label>Unit Price (INR) *</label>
          <input id="editStockPrice" type="number" min="1" value="${item.unitPrice}" required />
        </div>
        <div class="form-group">
          <label>Supplier</label>
          <input id="editStockSupplier" type="text" value="${item.supplier || ''}" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="editStockDescription" placeholder="Product description or notes..." rows="3">${item.description || ''}</textarea>
        </div>
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">Stock Summary</div>
          <div id="editStockSummary" style="color: var(--gray-600); font-size: 0.875rem;">Fill in the details above to see summary</div>
        </div>
      `;
      
      openModal('Edit Stock Item', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Update Item', type: 'primary', action: () => {
          const name = document.getElementById('editStockName').value.trim();
          const category = document.getElementById('editStockCategory').value;
          const currentStock = parseInt(document.getElementById('editStockCurrent').value, 10);
          const minRequired = parseInt(document.getElementById('editStockMinRequired').value, 10);
          const unitPrice = parseInt(document.getElementById('editStockPrice').value, 10);
          const supplier = document.getElementById('editStockSupplier').value.trim();
          const description = document.getElementById('editStockDescription').value.trim();
          
          if (!name || !category || isNaN(currentStock) || isNaN(minRequired) || isNaN(unitPrice) || 
              currentStock < 0 || minRequired <= 0 || unitPrice <= 0) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const itemIndex = stock.findIndex(i => i.id === itemId);
          if (itemIndex === -1) return;
          
          const status = getStockStatus(currentStock, minRequired);
          const today = new Date().toISOString().slice(0, 10);
          
          stock[itemIndex] = {
            ...stock[itemIndex],
            name,
            category,
            currentStock,
            minRequired,
            unitPrice,
            status,
            supplier: supplier || 'N/A',
            description: description || 'No description',
            lastUpdated: today
          };
          
          saveStock(stock);
          closeModal();
          renderStock();
          showToast(`Stock item ${itemId} updated successfully`, 'success');
        }}
      ]);
      
      // Add real-time calculation for edit summary
      const updateEditSummary = () => {
        const currentStock = parseInt(document.getElementById('editStockCurrent').value, 10);
        const minRequired = parseInt(document.getElementById('editStockMinRequired').value, 10);
        const unitPrice = parseInt(document.getElementById('editStockPrice').value, 10);
        
        if (!isNaN(currentStock) && !isNaN(minRequired) && !isNaN(unitPrice) && 
            currentStock >= 0 && minRequired > 0 && unitPrice > 0) {
          const totalValue = currentStock * unitPrice;
          const status = getStockStatus(currentStock, minRequired);
          document.getElementById('editStockSummary').innerHTML = `
            <strong>Status:</strong> ${status}<br/>
            <strong>Total Value:</strong> ${formatINR(totalValue)}<br/>
            <strong>Stock Level:</strong> ${currentStock} / ${minRequired} (${Math.round((currentStock/minRequired)*100)}%)
          `;
        } else {
          document.getElementById('editStockSummary').textContent = 'Fill in the details above to see summary';
        }
      };
      
      // Add event listeners for real-time updates
      setTimeout(() => {
        const currentInput = document.getElementById('editStockCurrent');
        const minInput = document.getElementById('editStockMinRequired');
        const priceInput = document.getElementById('editStockPrice');
        
        if (currentInput) currentInput.addEventListener('input', updateEditSummary);
        if (minInput) minInput.addEventListener('input', updateEditSummary);
        if (priceInput) priceInput.addEventListener('input', updateEditSummary);
        
        // Initial summary update
        updateEditSummary();
      }, 100);
    }

    function adjustStock(itemId, evt) {
      if (evt) evt.stopPropagation();
      const stock = loadStock();
      const item = stock.find(i => i.id === itemId);
      if (!item) return;
      
      const body = `
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Current Stock</div>
          <div style="font-size: 1.1rem; font-weight: 600;">${item.name} - ${item.currentStock} units</div>
        </div>
        <div class="form-group">
          <label>Adjustment Type *</label>
          <select id="adjustmentType" required>
            <option value="">Select type...</option>
            <option value="add">Add Stock (+)</option>
            <option value="remove">Remove Stock (-)</option>
            <option value="set">Set Stock (=)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quantity *</label>
          <input id="adjustmentQty" type="number" min="1" placeholder="Enter quantity" required />
        </div>
        <div class="form-group">
          <label>Reason</label>
          <input id="adjustmentReason" type="text" placeholder="Reason for adjustment (optional)" />
        </div>
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">Adjustment Preview</div>
          <div id="adjustmentPreview" style="color: var(--gray-600); font-size: 0.875rem;">Select adjustment type and quantity to see preview</div>
        </div>
      `;
      
      openModal('Adjust Stock', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Apply Adjustment', type: 'primary', action: () => {
          const type = document.getElementById('adjustmentType').value;
          const qty = parseInt(document.getElementById('adjustmentQty').value, 10);
          const reason = document.getElementById('adjustmentReason').value.trim();
          
          if (!type || isNaN(qty) || qty <= 0) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const itemIndex = stock.findIndex(i => i.id === itemId);
          if (itemIndex === -1) return;
          
          let newStock = item.currentStock;
          switch (type) {
            case 'add':
              newStock = item.currentStock + qty;
              break;
            case 'remove':
              newStock = Math.max(0, item.currentStock - qty);
              break;
            case 'set':
              newStock = qty;
              break;
          }
          
          const status = getStockStatus(newStock, item.minRequired);
          const today = new Date().toISOString().slice(0, 10);
          
          stock[itemIndex] = {
            ...stock[itemIndex],
            currentStock: newStock,
            status,
            lastUpdated: today
          };
          
          saveStock(stock);
          closeModal();
          renderStock();
          showToast(`Stock adjusted successfully. New quantity: ${newStock}`, 'success');
        }}
      ]);
      
      // Add real-time calculation for adjustment preview
      const updatePreview = () => {
        const type = document.getElementById('adjustmentType').value;
        const qty = parseInt(document.getElementById('adjustmentQty').value, 10);
        
        if (type && !isNaN(qty) && qty > 0) {
          let newStock = item.currentStock;
          let operation = '';
          switch (type) {
            case 'add':
              newStock = item.currentStock + qty;
              operation = `${item.currentStock} + ${qty}`;
              break;
            case 'remove':
              newStock = Math.max(0, item.currentStock - qty);
              operation = `${item.currentStock} - ${qty}`;
              break;
            case 'set':
              newStock = qty;
              operation = `= ${qty}`;
              break;
          }
          const status = getStockStatus(newStock, item.minRequired);
          document.getElementById('adjustmentPreview').innerHTML = `
            <strong>Calculation:</strong> ${operation} = ${newStock} units<br/>
            <strong>New Status:</strong> ${status}<br/>
            <strong>Stock Level:</strong> ${Math.round((newStock/item.minRequired)*100)}%
          `;
        } else {
          document.getElementById('adjustmentPreview').textContent = 'Select adjustment type and quantity to see preview';
        }
      };
      
      // Add event listeners for real-time updates
      setTimeout(() => {
        const typeSelect = document.getElementById('adjustmentType');
        const qtyInput = document.getElementById('adjustmentQty');
        
        if (typeSelect) typeSelect.addEventListener('change', updatePreview);
        if (qtyInput) qtyInput.addEventListener('input', updatePreview);
      }, 100);
    }

    function deleteStockItem(itemId, evt) {
      if (evt) evt.stopPropagation();
      confirmModal('Delete Stock Item', 'Are you sure you want to delete this stock item?', () => {
        const stock = loadStock();
        const filtered = stock.filter(item => item.id !== itemId);
        saveStock(filtered);
        renderStock();
        showToast('Stock item deleted successfully', 'success');
      });
    }

    // --------------------
    // Financial Management Functions
    // --------------------
    function renderFinancialRecords() {
      const tbody = document.getElementById('financialTbody');
      if (!tbody) return;
      const records = loadFinancialRecords();
      
      // Get filter values
      const typeFilter = document.getElementById('financialTypeFilter')?.value || '';
      const startEl = document.getElementById('financialDateStart');
      const endEl = document.getElementById('financialDateEnd');
      const searchEl = document.getElementById('searchFinancialRecords');
      const sortEl = document.getElementById('sortFinancialRecords');
      
      const startVal = startEl && startEl.value ? new Date(startEl.value) : null;
      const endVal = endEl && endEl.value ? new Date(endEl.value) : null;
      const searchTerm = searchEl ? searchEl.value.toLowerCase() : '';
      const sortBy = sortEl ? sortEl.value : 'date-desc';
      
      // Apply filters
      let filtered = records.filter(record => {
        // Type filter
        if (typeFilter && record.type !== typeFilter) return false;
        
        // Date range filter
        const recordDate = new Date(record.date);
        if (startVal && recordDate < startVal) return false;
        if (endVal && recordDate > endVal) return false;
        
        // Search filter
        if (searchTerm) {
          const searchText = `${record.description} ${record.amount} ${record.reference || ''}`.toLowerCase();
          if (!searchText.includes(searchTerm)) return false;
        }
        
        return true;
      });
      
      // Apply sorting
      filtered.sort((a, b) => {
        switch (sortBy) {
          case 'date-desc':
            return new Date(b.date) - new Date(a.date);
          case 'date-asc':
            return new Date(a.date) - new Date(b.date);
          case 'amount-desc':
            return b.amount - a.amount;
          case 'amount-asc':
            return a.amount - b.amount;
          case 'type':
            return a.type.localeCompare(b.type);
          default:
            return 0;
        }
      });
      
      tbody.innerHTML = filtered.map(record => {
        const dropdownId = `financialDropdown_${record.id}`;
        const actions = `
          <div class="dropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown('${dropdownId}')">
              <i class="pi pi-ellipsis-v"></i> Actions
            </button>
            <div class="dropdown-menu" id="${dropdownId}">
              <a class="dropdown-item" onclick="viewFinancialRecord('${record.id}', event); closeAllDropdowns();">
                <i class="pi pi-eye"></i> View Details
              </a>
              <a class="dropdown-item" onclick="editFinancialRecord('${record.id}', event); closeAllDropdowns();">
                <i class="pi pi-pencil"></i> Edit Record
              </a>
              ${record.status === 'Pending' ? `
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" onclick="markFinancialPaid('${record.id}', event); closeAllDropdowns();">
                  <i class="pi pi-check"></i> Mark Paid
                </a>
              ` : ''}
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="deleteFinancialRecord('${record.id}', event); closeAllDropdowns();" style="color: var(--error-500);">
                <i class="pi pi-trash"></i> Delete Record
              </a>
            </div>
          </div>
        `;
        
        return `
          <tr>
            <td>${record.date}</td>
            <td><strong>${record.type}</strong></td>
            <td>${record.description}</td>
            <td>${formatINR(record.amount)}</td>
            <td><span class="${financialBadgeClass(record.status)}">${record.status}</span></td>
            <td>${record.paymentMethod}</td>
            <td>${record.reference || 'N/A'}</td>
            <td>${actions}</td>
          </tr>
        `;
      }).join('');
      
      // Update financial statistics
      updateFinancialStats(records);
    }

    function updateFinancialStats(records) {
      const machineEMI = records.filter(r => r.type === 'Machine EMI').reduce((sum, r) => sum + r.amount, 0);
      const electricBill = records.filter(r => r.type === 'Electric Bill').reduce((sum, r) => sum + r.amount, 0);
      const transportCost = records.filter(r => r.type === 'Transport Cost').reduce((sum, r) => sum + r.amount, 0);
      const commission = records.filter(r => r.type === 'Commission').reduce((sum, r) => sum + r.amount, 0);
      
      const machineEMIEl = document.getElementById('totalMachineEMI');
      const electricBillEl = document.getElementById('totalElectricBill');
      const transportCostEl = document.getElementById('totalTransportCost');
      const commissionEl = document.getElementById('totalCommission');
      
      if (machineEMIEl) machineEMIEl.textContent = formatINR(machineEMI);
      if (electricBillEl) electricBillEl.textContent = formatINR(electricBill);
      if (transportCostEl) transportCostEl.textContent = formatINR(transportCost);
      if (commissionEl) commissionEl.textContent = formatINR(commission);
    }

    function applyFinancialFilters() {
      renderFinancialRecords();
    }

    function addFinancialRecord() {
      const body = `
        <div class="form-group">
          <label>Record Type *</label>
          <select id="financialType" required>
            <option value="">Select type...</option>
            ${FINANCIAL_TYPES.map(type => `<option value="${type}">${type}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Description *</label>
          <input id="financialDescription" type="text" placeholder="Enter description" required />
        </div>
        <div class="form-group">
          <label>Amount (INR) *</label>
          <input id="financialAmount" type="number" min="1" placeholder="Enter amount" required />
        </div>
        <div class="form-group">
          <label>Payment Status *</label>
          <select id="financialStatus" required>
            <option value="">Select status...</option>
            ${PAYMENT_STATUS.map(status => `<option value="${status}">${status}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Payment Method *</label>
          <select id="financialPaymentMethod" required>
            <option value="">Select method...</option>
            ${PAYMENT_METHODS.map(method => `<option value="${method}">${method}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Reference Number</label>
          <input id="financialReference" type="text" placeholder="Enter reference number (optional)" />
        </div>
        <div class="form-group">
          <label>Date *</label>
          <input id="financialDate" type="date" required />
        </div>
        <div class="form-group">
          <label>Due Date</label>
          <input id="financialDueDate" type="date" />
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="financialNotes" placeholder="Additional notes (optional)" rows="3"></textarea>
        </div>
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">Record Summary</div>
          <div id="financialSummary" style="color: var(--gray-600); font-size: 0.875rem;">Fill in the details above to see summary</div>
        </div>
      `;
      
      openModal('Add Financial Record', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Add Record', type: 'primary', action: () => {
          const type = document.getElementById('financialType').value;
          const description = document.getElementById('financialDescription').value.trim();
          const amount = parseInt(document.getElementById('financialAmount').value, 10);
          const status = document.getElementById('financialStatus').value;
          const paymentMethod = document.getElementById('financialPaymentMethod').value;
          const reference = document.getElementById('financialReference').value.trim();
          const date = document.getElementById('financialDate').value;
          const dueDate = document.getElementById('financialDueDate').value;
          const notes = document.getElementById('financialNotes').value.trim();
          
          if (!type || !description || isNaN(amount) || !status || !paymentMethod || !date || amount <= 0) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const records = loadFinancialRecords();
          const id = generateFinancialId(records);
          
          const newRecord = {
            id,
            type,
            description,
            amount,
            status,
            paymentMethod,
            reference: reference || 'N/A',
            date,
            dueDate: dueDate || date,
            notes: notes || 'No notes'
          };
          
          records.unshift(newRecord);
          saveFinancialRecords(records);
          closeModal();
          renderFinancialRecords();
          showToast(`Financial record ${id} added successfully`, 'success');
        }}
      ]);
      
      // Add real-time calculation for financial summary
      const updateSummary = () => {
        const type = document.getElementById('financialType').value;
        const amount = parseInt(document.getElementById('financialAmount').value, 10);
        const status = document.getElementById('financialStatus').value;
        const paymentMethod = document.getElementById('financialPaymentMethod').value;
        
        if (type && !isNaN(amount) && amount > 0 && status && paymentMethod) {
          document.getElementById('financialSummary').innerHTML = `
            <strong>Type:</strong> ${type}<br/>
            <strong>Amount:</strong> ${formatINR(amount)}<br/>
            <strong>Status:</strong> ${status}<br/>
            <strong>Payment:</strong> ${paymentMethod}
          `;
        } else {
          document.getElementById('financialSummary').textContent = 'Fill in the details above to see summary';
        }
      };
      
      // Add event listeners for real-time updates
      setTimeout(() => {
        const typeSelect = document.getElementById('financialType');
        const amountInput = document.getElementById('financialAmount');
        const statusSelect = document.getElementById('financialStatus');
        const methodSelect = document.getElementById('financialPaymentMethod');
        
        if (typeSelect) typeSelect.addEventListener('change', updateSummary);
        if (amountInput) amountInput.addEventListener('input', updateSummary);
        if (statusSelect) statusSelect.addEventListener('change', updateSummary);
        if (methodSelect) methodSelect.addEventListener('change', updateSummary);
      }, 100);
    }

    function viewFinancialRecord(recordId, evt) {
      if (evt) evt.stopPropagation();
      const records = loadFinancialRecords();
      const record = records.find(r => r.id === recordId);
      if (!record) return;
      
      const statusBadge = `<span class="${financialBadgeClass(record.status)}">${record.status}</span>`;
      
      const html = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem;">Record ID</div>
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--brand-600);">${record.id}</div>
          </div>
          <div>
            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem;">Status</div>
            <div>${statusBadge}</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Record Details</div>
          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${record.description}</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><strong>Type:</strong> ${record.type}</div>
            <div><strong>Amount:</strong> ${formatINR(record.amount)}</div>
            <div><strong>Payment Method:</strong> ${record.paymentMethod}</div>
            <div><strong>Reference:</strong> ${record.reference}</div>
            <div><strong>Date:</strong> ${record.date}</div>
            <div><strong>Due Date:</strong> ${record.dueDate}</div>
          </div>
        </div>
        
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
          <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">Notes</div>
          <div style="font-size: 0.9rem; color: var(--gray-600);">${record.notes}</div>
        </div>
      `;
      
      const buttons = [
        { label: 'Close', type: 'secondary', action: closeModal }
      ];
      
      if (record.status === 'Pending') {
        buttons.push({ 
          label: 'Mark Paid', 
          type: 'primary', 
          action: () => { 
            closeModal(); 
            markFinancialPaid(recordId); 
          } 
        });
      }
      
      buttons.push({ 
        label: 'Edit Record', 
        type: 'secondary', 
        action: () => { 
          closeModal(); 
          editFinancialRecord(recordId); 
        } 
      });
      
      openModal('Financial Record Details', html, buttons, 'large');
    }

    function editFinancialRecord(recordId) {
      const records = loadFinancialRecords();
      const record = records.find(r => r.id === recordId);
      if (!record) return;
      
      const body = `
        <div class="form-group">
          <label>Record Type *</label>
          <select id="editFinancialType" required>
            <option value="">Select type...</option>
            ${FINANCIAL_TYPES.map(type => 
              `<option value="${type}" ${record.type === type ? 'selected' : ''}>${type}</option>`
            ).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Description *</label>
          <input id="editFinancialDescription" type="text" value="${record.description}" required />
        </div>
        <div class="form-group">
          <label>Amount (INR) *</label>
          <input id="editFinancialAmount" type="number" min="1" value="${record.amount}" required />
        </div>
        <div class="form-group">
          <label>Payment Status *</label>
          <select id="editFinancialStatus" required>
            <option value="">Select status...</option>
            ${PAYMENT_STATUS.map(status => 
              `<option value="${status}" ${record.status === status ? 'selected' : ''}>${status}</option>`
            ).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Payment Method *</label>
          <select id="editFinancialPaymentMethod" required>
            <option value="">Select method...</option>
            ${PAYMENT_METHODS.map(method => 
              `<option value="${method}" ${record.paymentMethod === method ? 'selected' : ''}>${method}</option>`
            ).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>Reference Number</label>
          <input id="editFinancialReference" type="text" value="${record.reference || ''}" />
        </div>
        <div class="form-group">
          <label>Date *</label>
          <input id="editFinancialDate" type="date" value="${record.date}" required />
        </div>
        <div class="form-group">
          <label>Due Date</label>
          <input id="editFinancialDueDate" type="date" value="${record.dueDate || ''}" />
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="editFinancialNotes" placeholder="Additional notes (optional)" rows="3">${record.notes || ''}</textarea>
        </div>
        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem;">Record Summary</div>
          <div id="editFinancialSummary" style="color: var(--gray-600); font-size: 0.875rem;">Fill in the details above to see summary</div>
        </div>
      `;
      
      openModal('Edit Financial Record', body, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Update Record', type: 'primary', action: () => {
          const type = document.getElementById('editFinancialType').value;
          const description = document.getElementById('editFinancialDescription').value.trim();
          const amount = parseInt(document.getElementById('editFinancialAmount').value, 10);
          const status = document.getElementById('editFinancialStatus').value;
          const paymentMethod = document.getElementById('editFinancialPaymentMethod').value;
          const reference = document.getElementById('editFinancialReference').value.trim();
          const date = document.getElementById('editFinancialDate').value;
          const dueDate = document.getElementById('editFinancialDueDate').value;
          const notes = document.getElementById('editFinancialNotes').value.trim();
          
          if (!type || !description || isNaN(amount) || !status || !paymentMethod || !date || amount <= 0) {
            showToast('Please fill all required fields correctly', 'error');
            return;
          }
          
          const recordIndex = records.findIndex(r => r.id === recordId);
          if (recordIndex === -1) return;
          
          records[recordIndex] = {
            ...records[recordIndex],
            type,
            description,
            amount,
            status,
            paymentMethod,
            reference: reference || 'N/A',
            date,
            dueDate: dueDate || date,
            notes: notes || 'No notes'
          };
          
          saveFinancialRecords(records);
          closeModal();
          renderFinancialRecords();
          showToast(`Financial record ${recordId} updated successfully`, 'success');
        }}
      ]);
      
      // Add real-time calculation for edit summary
      const updateEditSummary = () => {
        const type = document.getElementById('editFinancialType').value;
        const amount = parseInt(document.getElementById('editFinancialAmount').value, 10);
        const status = document.getElementById('editFinancialStatus').value;
        const paymentMethod = document.getElementById('editFinancialPaymentMethod').value;
        
        if (type && !isNaN(amount) && amount > 0 && status && paymentMethod) {
          document.getElementById('editFinancialSummary').innerHTML = `
            <strong>Type:</strong> ${type}<br/>
            <strong>Amount:</strong> ${formatINR(amount)}<br/>
            <strong>Status:</strong> ${status}<br/>
            <strong>Payment:</strong> ${paymentMethod}
          `;
        } else {
          document.getElementById('editFinancialSummary').textContent = 'Fill in the details above to see summary';
        }
      };
      
      // Add event listeners for real-time updates
      setTimeout(() => {
        const typeSelect = document.getElementById('editFinancialType');
        const amountInput = document.getElementById('editFinancialAmount');
        const statusSelect = document.getElementById('editFinancialStatus');
        const methodSelect = document.getElementById('editFinancialPaymentMethod');
        
        if (typeSelect) typeSelect.addEventListener('change', updateEditSummary);
        if (amountInput) amountInput.addEventListener('input', updateEditSummary);
        if (statusSelect) statusSelect.addEventListener('change', updateEditSummary);
        if (methodSelect) methodSelect.addEventListener('change', updateEditSummary);
        
        // Initial summary update
        updateEditSummary();
      }, 100);
    }

    function markFinancialPaid(recordId, evt) {
      if (evt) evt.stopPropagation();
      const records = loadFinancialRecords();
      const recordIndex = records.findIndex(r => r.id === recordId);
      if (recordIndex === -1) return;
      
      records[recordIndex].status = 'Paid';
      saveFinancialRecords(records);
      renderFinancialRecords();
      showToast(`Financial record ${recordId} marked as paid`, 'success');
    }

    function deleteFinancialRecord(recordId, evt) {
      if (evt) evt.stopPropagation();
      confirmModal('Delete Financial Record', 'Are you sure you want to delete this financial record?', () => {
        const records = loadFinancialRecords();
        const filtered = records.filter(r => r.id !== recordId);
        saveFinancialRecords(filtered);
        renderFinancialRecords();
        showToast('Financial record deleted successfully', 'success');
      });
    }

    // Initial render if Orders is visible by default (not in this layout)
    document.addEventListener('DOMContentLoaded', () => {
      refreshDashboardStats();
      if (!document.getElementById('orders').classList.contains('hidden')) {
        renderOrders();
      }
      if (!document.getElementById('stock').classList.contains('hidden')) {
        renderStock();
      }
      if (!document.getElementById('financial').classList.contains('hidden')) {
        renderFinancialRecords();
      }
      // Order filters are now handled by the onchange/oninput attributes in the HTML
      // Pre-render GST and Staff if opened directly
      if (!document.getElementById('gst').classList.contains('hidden')) renderGstReturns();
      if (!document.getElementById('staff').classList.contains('hidden')) renderStaff();
    });
  </script>
  
  <script>
    // Dropdown Menu Helpers
    function toggleDropdown(dropdownId) {
      // Close all other dropdowns
      document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
        if (menu.id !== dropdownId) {
          menu.classList.remove('show');
        }
      });
      
      // Toggle current dropdown
      const dropdown = document.getElementById(dropdownId);
      if (dropdown) {
        dropdown.classList.toggle('show');
      }
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.dropdown')) {
        closeAllDropdowns();
      }
    });

    // Modal & Toast Helpers
    function checkModalElements() {
      const overlay = document.getElementById('modalOverlay');
      const modal = document.querySelector('.modal');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalBody');
      const footer = document.getElementById('modalFooter');
      
      console.log('Modal elements check:');
      console.log('Overlay:', overlay ? 'Found' : 'Missing');
      console.log('Modal:', modal ? 'Found' : 'Missing');
      console.log('Title:', title ? 'Found' : 'Missing');
      console.log('Body:', body ? 'Found' : 'Missing');
      console.log('Footer:', footer ? 'Found' : 'Missing');
      
      return { overlay, modal, title, body, footer };
    }
    
    function openModal(title, htmlBody, buttons, size = 'normal') {
      const overlay = document.getElementById('modalOverlay');
      const modal = document.querySelector('.modal');
      const t = document.getElementById('modalTitle');
      const b = document.getElementById('modalBody');
      const f = document.getElementById('modalFooter');
      
      if (!overlay || !modal || !t || !b || !f) {
        console.error('Modal elements not found:', {overlay, modal, t, b, f});
        alert('Modal system error. Please refresh the page.');
        return;
      }
      
      // Reset modal size classes
      modal.classList.remove('modal-large', 'modal-xl');
      
      // Apply size class if specified
      if (size === 'large') {
        modal.classList.add('modal-large');
      } else if (size === 'xl') {
        modal.classList.add('modal-xl');
      }
      
      t.textContent = title || 'Details';
      b.innerHTML = htmlBody || '';
      f.innerHTML = '';
      
      if (buttons && buttons.length > 0) {
        buttons.forEach(btn => {
          const el = document.createElement('button');
          el.className = 'btn ' + (btn.type === 'primary' ? 'btn-primary' : 'btn-secondary') + ' btn-sm';
          el.textContent = btn.label;
          el.onclick = () => { 
            try {
              if (btn.action) btn.action(); 
            } catch (error) {
              console.error('Button action error:', error);
            }
          };
          f.appendChild(el);
        });
      } else {
        // Default close button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-secondary btn-sm';
        closeBtn.textContent = 'Close';
        closeBtn.onclick = closeModal;
        f.appendChild(closeBtn);
      }
      
      overlay.classList.add('active');
      console.log('Modal opened:', title);
    }
    function closeModal() {
      const overlay = document.getElementById('modalOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }
    }
    function confirmModal(title, message, onConfirm) {
      openModal(title || 'Confirm', `<div>${message || ''}</div>`, [
        { label: 'Cancel', type: 'secondary', action: closeModal },
        { label: 'Confirm', type: 'primary', action: () => { closeModal(); if (onConfirm) onConfirm(); } }
      ]);
    }
    function showToast(message, variant) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast ' + (variant || '');
      toast.textContent = message || '';
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity .4s ease';
        setTimeout(() => toast.remove(), 400);
      }, 2000);
    }
    
    function testModalFix() {
      console.log('Testing modal functionality...');
      checkModalElements();
      
      const testHtml = `
        <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 1rem;">
          <h4>Modal Test</h4>
          <p>If you can see this modal, the modal system is working!</p>
          <div class="form-group">
            <label>Test Input</label>
            <input type="text" placeholder="Type something here..." />
          </div>
        </div>
      `;
      
      openModal('Modal Test', testHtml, [
        { label: 'Close', type: 'secondary', action: closeModal },
        { label: 'Test Success', type: 'primary', action: () => {
          showToast('Modal test successful!', 'success');
          closeModal();
        }}
      ]);
    }
  </script>
  
  <script>
    // GST Returns Store + UI
    const GST_STORAGE_KEY = 'logosic_gst_returns_v1';
    function loadGst(){ try{ const r=localStorage.getItem(GST_STORAGE_KEY); if(r) return JSON.parse(r);}catch(_){} const seeded=[
      { gstin:'29ABCDE1234F1Z5', type:'GSTR-1', period:'2025-08', taxable:1364445, igst:43200, cgst:194400, sgst:194400, total:432000, filedDate:'2025-09-10', dueDate:'2025-09-11', status:'Filed' },
      { gstin:'29ABCDE1234F1Z5', type:'GSTR-3B', period:'2025-08', taxable:1364445, igst:0, cgst:194400, sgst:194400, total:388800, filedDate:'2025-09-18', dueDate:'2025-09-20', status:'Filed' }
    ]; saveGst(seeded); return seeded; }
    function saveGst(list){ localStorage.setItem(GST_STORAGE_KEY, JSON.stringify(list)); }
    function gstBadge(status){ const s=(status||'').toLowerCase(); if(s==='filed') return 'status-badge status-filed'; if(s==='draft') return 'status-badge status-draft'; return 'status-badge status-pending'; }
    function renderGstReturns(){ 
      const tbody=document.getElementById('gstTbody'); 
      if(!tbody) return; 
      const list=loadGst(); 
      tbody.innerHTML=list.map(r=>{
        const dropdownId = `gstDropdown_${r.gstin}_${r.type}_${r.period}`.replace(/[^a-zA-Z0-9_]/g, '_');
        const actions = `
          <div class="dropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown('${dropdownId}')">
              <i class="pi pi-ellipsis-v"></i> Actions
            </button>
            <div class="dropdown-menu" id="${dropdownId}">
              <a class="dropdown-item" onclick="viewGst('${r.gstin}','${r.type}','${r.period}',event); closeAllDropdowns();">
                <i class="pi pi-eye"></i> View Details
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="printGst('${r.gstin}','${r.type}','${r.period}',event); closeAllDropdowns();">
                <i class="pi pi-print"></i> Print Return
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" onclick="deleteGst('${r.gstin}','${r.type}','${r.period}',event); closeAllDropdowns();" style="color: var(--error-500);">
                <i class="pi pi-trash"></i> Delete Return
              </a>
            </div>
          </div>
        `;
        return `
      <tr>
        <td>${r.gstin}</td>
        <td>${r.type}</td>
        <td>${r.period}</td>
        <td>${formatINR(r.taxable)}</td>
        <td>${formatINR(r.igst)}</td>
        <td>${formatINR(r.cgst)}</td>
        <td>${formatINR(r.sgst)}</td>
        <td>${formatINR(r.total)}</td>
        <td><span class="${gstBadge(r.status)}">${r.status}</span></td>
            <td>${actions}</td>
      </tr>
        `;
      }).join(''); 
    }
    function openGstReturnModal(){ const body=`
      <div class="form-group"><label>GSTIN</label><input id="gstGstin" type="text" placeholder="29ABCDE1234F1Z5" /></div>
      <div class="form-group"><label>Return Type</label><select id="gstType"><option>GSTR-1</option><option>GSTR-3B</option></select></div>
      <div class="form-group"><label>Period</label><input id="gstPeriod" type="month" /></div>
      <div class="form-group"><label>Taxable Value (INR)</label><input id="gstTaxable" type="number" min="0" /></div>
    `; openModal('File GST Return', body, [
      { label:'Cancel', type:'secondary', action: closeModal },
      { label:'Save', type:'primary', action: () => {
        const gstin=document.getElementById('gstGstin').value.trim();
        const type=document.getElementById('gstType').value;
        const period=(document.getElementById('gstPeriod').value||'').replace('-','-');
        const taxable=parseInt(document.getElementById('gstTaxable').value,10)||0;
        if(!gstin||!type||!period||taxable<=0){ showToast('Please fill all fields correctly','error'); return; }
        // Compute basic taxes
        let igst=0, cgst=0, sgst=0; if(type==='GSTR-1'){ igst=Math.round(taxable*0.03); cgst=Math.round(taxable*0.09); sgst=Math.round(taxable*0.09); }
        if(type==='GSTR-3B'){ cgst=Math.round(taxable*0.09); sgst=Math.round(taxable*0.09); }
        const total=igst+cgst+sgst; const due = new Date(period+'-11').toISOString().slice(0,10);
        const list=loadGst();
        const exists = list.find(r=>r.gstin===gstin && r.type===type && r.period===period);
        const entry={ gstin, type, period, taxable, igst, cgst, sgst, total, filedDate:'-', dueDate:due, status:'Draft' };
        if(exists){ Object.assign(exists, entry); } else { list.unshift(entry); }
        saveGst(list); closeModal(); renderGstReturns(); showToast('GST return saved','success');
      }}
    ]); }
    function findGst(gstin,type,period){ return loadGst().find(r=>r.gstin===gstin && r.type===type && r.period===period); }
    function viewGst(gstin,type,period,evt){ if(evt) evt.stopPropagation(); const r=findGst(gstin,type,period); if(!r) return; const html=`
      <div><strong>${r.type}</strong> — ${r.period}</div>
      <div style="color:var(--gray-600);margin:.25rem 0 1rem 0">GSTIN: ${r.gstin}</div>
      <div>Taxable: ${formatINR(r.taxable)}</div>
      <div>IGST: ${formatINR(r.igst)} &nbsp; CGST: ${formatINR(r.cgst)} &nbsp; SGST: ${formatINR(r.sgst)}</div>
      <div style="margin-top:.5rem"><strong>Total:</strong> ${formatINR(r.total)} &nbsp; <strong>Status:</strong> ${r.status}</div>
      <div class="muted">Due: ${r.dueDate} • Filed: ${r.filedDate}</div>
    `; openModal('GST Return', html, [ {label:'Close', type:'secondary', action: closeModal}, {label:'Print', type:'primary', action:()=>{closeModal(); printGst(gstin,type,period);}} ]); }
    function deleteGst(gstin,type,period,evt){ if(evt) evt.stopPropagation(); confirmModal('Delete GST Return','Are you sure?',()=>{ let list=loadGst(); list=list.filter(r=>!(r.gstin===gstin && r.type===type && r.period===period)); saveGst(list); renderGstReturns(); }); }
    function printGst(gstin,type,period,evt){ if(evt) evt.stopPropagation(); const r=findGst(gstin,type,period); if(!r) return; const qr=encodeURIComponent(`${r.gstin}|${r.type}|${r.period}|${r.total}`); const qrUrl=`https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${qr}`; const html=`
      <html><head><meta charset='utf-8'><title>${r.type} ${r.period}</title><style>body{font-family:Inter,Segoe UI,Roboto,sans-serif;background:#f8fafc;margin:0;padding:24px;color:#111827}.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:24px;max-width:900px;margin:0 auto} table{border-collapse:collapse;width:100%;margin-top:12px} th,td{border:1px solid #e5e7eb;padding:8px} th{background:#f9fafb;text-align:left}</style></head><body>
      <div class='card'>
        <div style='display:flex;justify-content:space-between;align-items:flex-start'>
          <div>
            <div style='font-weight:700'>Logosic Logistics</div>
            <div style='color:#6b7280'>GST Return Summary</div>
          </div>
          <img src='${qrUrl}' width='120' height='120'/>
        </div>
        <table>
          <tr><th>GSTIN</th><td>${r.gstin}</td><th>Return Type</th><td>${r.type}</td></tr>
          <tr><th>Period</th><td>${r.period}</td><th>Status</th><td>${r.status}</td></tr>
        </table>
        <table>
          <tr><th>Taxable Value</th><td>${formatINR(r.taxable)}</td><th>Total Tax</th><td>${formatINR(r.total)}</td></tr>
          <tr><th>IGST</th><td>${formatINR(r.igst)}</td><th>CGST</th><td>${formatINR(r.cgst)}</td></tr>
          <tr><th>SGST</th><td>${formatINR(r.sgst)}</td><th>Due Date</th><td>${r.dueDate}</td></tr>
        </table>
        <div style='color:#6b7280;margin-top:8px'>Filed Date: ${r.filedDate}</div>
      </div>
      <script>window.onload=()=>{window.print();setTimeout(()=>window.close(),300)}<\/script>
      </body></html>`; const w=window.open('','_blank'); if(!w){ showToast('Popup blocked. Allow popups.', 'error'); return;} w.document.open(); w.document.write(html); w.document.close(); }
  </script>
</body>
</html>